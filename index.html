<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Radar Ultra Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --ios-bg: #f2f2f7; --ios-item: #ffffff; --ios-text: #000000;
            --ios-blue: #007aff; --ios-red: #ff3b30; --ios-gray: #8e8e93;
            --map-filter: none;
        }
        body.dark-mode {
            --ios-bg: #000000; --ios-item: #1c1c1e; --ios-text: #ffffff;
            --ios-gray: #48484a;
            --map-filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--ios-bg); color: var(--ios-text); overflow: hidden; width: 100vw; transition: background 0.3s; }
        #map { height: 100vh; width: 100%; z-index: 1; filter: var(--map-filter); transition: filter 0.3s; }

        .ios-frame { position: fixed; top: 0; left: 0; width: 100vw; height: 100%; background: var(--ios-bg); z-index: 10000; display: none; flex-direction: column; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .ios-frame.active { display: flex; transform: translateY(0); }

        .g-btn { background: white; color: #3c4043; border: 1px solid #dadce0; padding: 12px 20px; border-radius: 12px; font-weight: 600; display: flex; align-items: center; gap: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 16px; margin: 20px auto; width: fit-content; }
        .g-logo-svg { width: 18px; height: 18px; }

        .toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(28,28,30,0.9); backdrop-filter: blur(15px); color: white; padding: 16px; border-radius: 20px; z-index: 50000; transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); text-align: center; font-weight: 500; }
        .toast.show { top: 60px; }
        .loader { width: 24px; height: 24px; border: 3px solid var(--ios-gray); border-top-color: var(--ios-blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .tower-dot { width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .dot-data { background: #34c759; } 
        .dot-tv { background: #af52de; }   

        #chat-frame { border-radius: 30px 30px 0 0; height: 85vh; top: 15vh; bottom: 0; position: fixed; }
        .chat-header { padding: 20px; border-bottom: 0.5px solid var(--ios-gray); display: flex; justify-content: space-between; align-items: center; }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 120px; }
        .chat-input-bar { position: absolute; bottom: 0; width: 100%; padding: 15px 15px calc(15px + env(safe-area-inset-bottom)) 15px; background: var(--ios-item); border-top: 0.5px solid var(--ios-gray); display: flex; gap: 10px; z-index: 10; }
        
        .btn-close-circle { width: 32px; height: 32px; background: var(--ios-gray); border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: none; background: var(--ios-bg); color: var(--ios-text); font-size: 16px; outline: none; }

        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(20px); }

        .empty-state { text-align: center; padding: 40px 20px; opacity: 0.5; font-size: 14px; }
        .loading-more { text-align: center; padding: 10px; font-size: 12px; opacity: 0.6; }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <div id="login-frame" class="ios-frame" style="display: flex; align-items: center; justify-content: center; text-align: center; padding: 30px;">
        <button class="btn-close-circle" style="position: absolute; top: 50px; right: 20px;" onclick="toggleFrame('login-frame', false)">‚úï</button>
        <div style="font-size: 60px;">üóº</div>
        <p style="font-size: 20px; font-weight: 700; margin: 20px 0;">Radar Ultra Pro</p>
        <p style="font-size: 16px; opacity: 0.8; margin-bottom: 30px;">Log in to join the community and see tower comments.</p>
        <button class="g-btn" onclick="signIn()">
            <svg class="g-logo-svg" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 12-4.53z" fill="#EA4335"/></svg>
            Continue with Google
        </button>
        <p style="font-size: 12px; color: var(--ios-gray); margin-top: 15px;">By continuing, you agree to the <span style="text-decoration: underline; cursor: pointer;" onclick="toggleFrame('terms-frame', true)">terms of use</span>.</p>
    </div>

    <div id="terms-frame" class="ios-frame" style="padding: 60px 25px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;">Terms of Use</h2>
            <button class="btn-close-circle" onclick="toggleFrame('terms-frame', false)">‚úï</button>
        </div>
        <div style="margin-top: 30px; line-height: 1.6; font-size: 15px;">
            <p>1. We will never store your location on our servers; it is only processed on your device.</p>
            <p>2. Your Google account data will be stored on our server named 'Firebase' created by Google.</p>
            <p>3. Offensive comments, spam, inappropriate, illegal, or false information are not allowed; your account will be permanently deactivated.</p>
            <p>4. By continuing to use this site, you agree to these terms of service.</p>
        </div>
    </div>

        <div id="settings-frame" class="ios-frame" style="padding: 60px 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2 style="margin:0;">Settings</h2>
            <button class="btn-close-circle" onclick="toggleFrame('settings-frame', false)">‚úï</button>
        </div>
        <div style="background:var(--ios-item); border-radius:14px; width:100%; overflow:hidden;">
            <div style="padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:0.5px solid var(--ios-gray);">
                <span>Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="dark-toggle" onclick="toggleDarkMode()">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="profile-btn" style="padding:15px; display:flex; justify-content:space-between;" onclick="showProfile()"><span>Account Profile</span><span>‚Ä∫</span></div>
        </div>
    </div>

    <div id="chat-frame" class="ios-frame">
        <div class="chat-header">
            <span id="chat-tower-id" style="font-weight:600; font-size:12px; opacity:0.5;">TOWER ID: --</span>
            <button class="btn-close-circle" onclick="toggleFrame('chat-frame', false)">‚úï</button>
        </div>
        <div id="chat-loading" class="loader"></div>
        <div id="chat-list" class="chat-list" onscroll="handleScroll(this)"></div>
        <div class="chat-input-bar">
            <input type="text" id="comm-input" maxlength="100" placeholder="Min. 10 characters..." oninput="checkInput()">
            <button id="btn-send" disabled onclick="sendComment()" style="background:none; border:none; color:var(--ios-blue); font-weight:700; font-size:16px; opacity:0.3;">Send</button>
        </div>
    </div>

    <button onclick="toggleFrame('settings-frame', true)" style="position:fixed; bottom:30px; left:20px; z-index:1000; width:54px; height:54px; border-radius:50%; background:var(--ios-item); border:none; font-size:24px; box-shadow:0 4px 15px rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center;">‚öôÔ∏è</button>
    <button onclick="getMyPos()" style="position:fixed; bottom:30px; right:20px; z-index:1000; width:54px; height:54px; border-radius:50%; background:var(--ios-item); border:none; font-size:24px; box-shadow:0 4px 15px rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center;">üéØ</button>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, startAfter, getDocs, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-9mGZUB4m_vuc8mAATPtpiQdinb4nYx0",
            authDomain: "radar-database-3448b.firebaseapp.com",
            projectId: "radar-database-3448b",
            storageBucket: "radar-database-3448b.appspot.com",
            messagingSenderId: "927242352551",
            appId: "1:927242352551:web:a980043e310d5dc1e2e882"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null, currentTowerId = null, lastVisible = null, isBatchLoading = false, hasMore = true;

        // Load Settings from LocalStorage
        window.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-toggle').checked = true;
            }
        });

        window.toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                toggleFrame('login-frame', false);
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                if (!snap.exists()) await setDoc(userRef, { dailyCount: 0, lastPost: serverTimestamp(), commentCount: 0 });
            } else {
                setTimeout(() => { if(!currentUser) toggleFrame('login-frame', true); }, 2000);
            }
        });

        window.signIn = async () => {
            try { await signInWithPopup(auth, provider); showToast("Welcome back!"); } 
            catch (e) { showToast("Sign-in failed."); }
        };

        const map = L.map('map', { zoomControl: false, tap: false }).setView([-15.78, -47.92], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markersLayer = L.layerGroup().addTo(map);

        window.openChat = (id) => {
            currentTowerId = id;
            lastVisible = null; hasMore = true;
            document.getElementById('chat-list').innerHTML = "";
            document.getElementById('chat-tower-id').innerText = `TOWER ID: ${id}`;
            toggleFrame('chat-frame', true);
            loadComments(true);
        };

        window.loadComments = async (isNew = false) => {
            if (isBatchLoading || (!hasMore && !isNew)) return;
            isBatchLoading = true;
            const list = document.getElementById('chat-list');
            const loader = document.getElementById('chat-loading');
            if(isNew) loader.style.display = 'block';

            let q = query(collection(db, "comments"), where("towerId", "==", currentTowerId), orderBy("createdAt", "desc"), limit(15));
            if (!isNew && lastVisible) q = query(q, startAfter(lastVisible));

            try {
                const snap = await getDocs(q);
                loader.style.display = 'none';
                if (snap.empty) {
                    if(isNew) list.innerHTML = `<div class="empty-state">No comments yet.</div>`;
                    hasMore = false;
                } else {
                    lastVisible = snap.docs[snap.docs.length - 1];
                    if (snap.docs.length < 15) hasMore = false;
                    snap.forEach(d => {
                        const c = d.data();
                        const item = document.createElement('div');
                        item.style = "background:var(--ios-item);padding:12px;border-radius:15px;margin-bottom:10px;display:flex;gap:12px;";
                        item.innerHTML = `<img src="${c.userPhoto}" style="width:36px;height:36px;border-radius:50%;"><div><b>${c.username || 'User'}</b><p style="margin:4px 0;font-size:14px;">${c.text}</p></div>`;
                        list.appendChild(item);
                    });
                }
            } catch (e) { showToast("Error loading comments."); }
            isBatchLoading = false;
        };

        window.handleScroll = (el) => {
            if (el.scrollTop + el.clientHeight >= el.scrollHeight - 20) loadComments(false);
        };

        window.sendComment = async () => {
            if(!currentUser) return showToast("Login required.");
            const input = document.getElementById('comm-input');
            const text = input.value.trim();
            try {
                await addDoc(collection(db, "comments"), {
                    towerId: currentTowerId, text, userId: currentUser.uid,
                    username: currentUser.displayName, userPhoto: currentUser.photoURL,
                    createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, "users", currentUser.uid), { commentCount: increment(1), lastPost: serverTimestamp() });
                input.value = ""; checkInput(); showToast("Sent!");
                openChat(currentTowerId); // Reload automatic
            } catch (e) { showToast("Wait 15s to post again."); }
        };

        window.toggleFrame = (id, show) => {
            const f = document.getElementById(id);
            if(show) { f.style.display = 'flex'; setTimeout(() => f.classList.add('active'), 10); }
            else { f.classList.remove('active'); setTimeout(() => { if(!f.classList.contains('active')) f.style.display = 'none'; }, 400); }
        };

        window.showToast = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
        window.checkInput = () => { const v = document.getElementById('comm-input').value.trim(); const b = document.getElementById('btn-send'); b.disabled = v.length < 10; b.style.opacity = v.length >= 10 ? "1" : "0.3"; };
        window.getMyPos = () => navigator.geolocation.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 16));
        window.carregarTorres = async () => {
            if (map.getZoom() < 14) return;
            const b = map.getBounds();
            const q = `[out:json][timeout:25];(node["man_made"~"mast|tower"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out body;`;
            const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(q));
            const data = await res.json();
            markersLayer.clearLayers();
            data.elements.forEach(el => {
                const marker = L.marker([el.lat, el.lon], { icon: L.divIcon({ className: `tower-dot dot-data` }) }).addTo(markersLayer);
                marker.bindPopup(`<div style="color:black;"><b>Tower ${el.id}</b><br><button onclick="openChat('${el.id}')" style="width:100%;background:var(--ios-blue);color:white;border:none;padding:8px;border-radius:8px;margin-top:8px;">Open Chat</button></div>`);
            });
        };
        map.on('moveend', carregarTorres);
    </script>
</body>
</html>
