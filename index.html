<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Radar Ultra Pro - Premium</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --bg-ui: #f8f9fa; --text-main: #1a1a1a; --item-bg: #ffffff; --border-color: #ddd; --accent: #007aff; }
        body.dark-mode { --bg-ui: #121212; --text-main: #e0e0e0; --item-bg: #1e1e1e; --border-color: #333; --accent: #4dabf7; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: var(--bg-ui); color: var(--text-main); }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* OVERLAYS E Z-INDEX PRIORIT√ÅRIO */
        #search-overlay, #config-overlay, #login-overlay, #terms-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-ui); z-index: 10000; display: none; flex-direction: column; padding: 15px; box-sizing: border-box; }
        #login-overlay { z-index: 10010; } /* Login na frente de tudo */
        
        /* FRAME DE LOGOUT / CARREGANDO */
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); color: white; }

        /* BANNER IOS 18 */
        .ios-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(20px); color: white; padding: 14px; border-radius: 22px; z-index: 30000; display: flex; align-items: center; justify-content: center; transition: top 0.5s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.3); font-size: 14px; }
        .ios-toast.show { top: 25px; }

        /* BOT√ÉO GOOGLE REAL */
        .btn-google { background: white; color: #444; border: 1px solid #ddd; padding: 12px; border-radius: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; width: 100%; margin: 20px 0; font-size: 16px; }
        .google-icon { width: 22px; height: 22px; }

        /* UI GERAL */
        .search-container { width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; height: 100%; }
        .search-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        input[type="text"] { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--item-bg); color: var(--text-main); font-size: 16px; margin-bottom: 10px; outline: none; }
        
        /* BOT√ïES FLUTUANTES */
        .fab { position: absolute; width: 55px; height: 55px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; }
        .btn-search { bottom: 30px; right: 20px; background: var(--accent); color: white; }
        .btn-config { bottom: 30px; left: 20px; background: #333; color: white; }
        .btn-locate { bottom: 100px; right: 20px; background: var(--item-bg); color: var(--text-main); }
        
        .btn-main { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn-main:active { opacity: 0.7; }
        .btn-logout { background: #ff3b30; margin-top: 15px; }

        /* BADGES */
        .badge-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: 800; color: white; text-transform: uppercase; }
        .bg-5g { background: linear-gradient(135deg, #6a11cb, #2575fc); }
        .bg-4g { background: #28a745; }

        /* CHAT FRAME */
        #comment-frame { position: fixed; bottom: -100%; left: 0; width: 100%; height: 85vh; background: var(--item-bg); z-index: 9998; transition: bottom 0.4s ease-out; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; box-shadow: 0 -5px 25px rgba(0,0,0,0.3); }
        #comment-frame.active { bottom: 0; }
        .comm-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .comm-list { flex: 1; overflow-y: auto; padding: 15px; }
        .comm-input-area { padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; background: var(--item-bg); }

        /* ANIMA√á√ÉO LOADER */
        .loader-spin { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="dark-mode">

    <div id="loader-overlay">
        <div class="loader-spin"></div>
        <p id="loader-text" style="margin-top: 15px; font-weight: 600;"></p>
    </div>

    <div id="ios-toast" class="ios-toast">Message</div>

    <div id="login-overlay">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center; padding: 20px;">
            <button class="btn-close-overlay" style="position:absolute; top:20px; right:20px; background:none; border:none; color:var(--text-main); font-size:30px;" onclick="toggleLogin(false)">‚úï</button>
            <div style="font-size: 60px; margin-bottom: 20px;">üì°</div>
            <h2 style="margin-bottom: 10px;">Log in to unlock tower features.</h2>
            <p style="opacity: 0.7; font-size: 14px;">Connect and contribute with the community.</p>
            
            <button class="btn-google" onclick="handleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa_loader/google_logo.svg" class="google-icon">
                Continue with Google
            </button>

            <p style="font-size: 13px; opacity: 0.8;">
                By continuing, you agree to our 
                <span style="color:var(--accent); text-decoration:underline; cursor:pointer;" onclick="toggleTerms(true)">terms of service</span>.
            </p>
        </div>
    </div>

    <div id="terms-overlay">
        <div class="search-container">
            <div class="search-header">
                <button style="background:none; border:none; color:var(--accent); font-size:24px; cursor:pointer;" onclick="toggleTerms(false)">‚Üê Back</button>
            </div>
            <h1 style="margin-top:0;">Terms of Service</h1>
            <div style="flex:1; overflow-y:auto; line-height:1.6; font-size:15px; opacity:0.9;">
                <p>‚Ä¢ We will never store your actual location on our servers; it will only be processed on your device.</p>
                <p>‚Ä¢ Your Google account data will be stored on our server called "Firebase", a trusted server provided by Google.</p>
                <p>‚Ä¢ Offensive, inappropriate, illegal, spam, or false information is not allowed. Your Google account will be permanently deactivated on our server. Every time you log in with it, it will give an error. (and no, your Google account will not be deactivated).</p>
                <p>‚Ä¢ By continuing, you agree to our terms of service.</p>
            </div>
        </div>
    </div>

    <div id="config-overlay">
        <div class="search-container">
            <div class="search-header"><h2>Settings</h2><button class="btn-main" style="width:auto" onclick="toggleConfig(false)">‚úï</button></div>
            <div style="background:var(--item-bg); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span>Dark Mode</span><input type="checkbox" id="dark-mode-toggle" onchange="alterarTema(this.checked)" checked>
            </div>
            <button class="btn-main" style="background:var(--item-bg); color:var(--text-main); text-align:left; margin-bottom:10px;" onclick="toggleTerms(true)">Terms of Service</button>
            
            <div id="user-info" style="margin-top:auto; padding-bottom:20px;">
                <button class="btn-main btn-logout" onclick="handleLogout()">Log out of your account</button>
            </div>
        </div>
    </div>

    <div id="search-overlay">
        <div class="search-container">
            <div class="search-header"><h2>Search</h2><button class="btn-main" style="width:auto" onclick="toggleSearch(false)">‚úï</button></div>
            <input type="text" id="search-input" placeholder="City or coordinates...">
            <button class="btn-main" onclick="realizarPesquisa()">SEARCH AREA</button>
            <div id="results-list" style="margin-top:20px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="comment-frame">
        <div class="comm-header">
            <h3 id="comm-tower-title">Tower Chat</h3>
            <button class="btn-main" style="background:none; color:var(--text-main); font-size:24px;" onclick="toggleComments(false)">‚úï</button>
        </div>
        <div id="comm-content" style="flex:1; display:flex; flex-direction:column;">
            <div class="comm-list" id="comm-container"></div>
            
            <div id="chat-auth-check" style="display:none; padding:30px; text-align:center;">
                <button class="btn-main" onclick="toggleLogin(true)">Log in to chat about this tower.</button>
            </div>

            <div class="comm-input-area" id="input-area">
                <input type="text" id="comm-input" placeholder="Say something...">
                <button class="btn-main" onclick="postarComentario()">SEND</button>
            </div>
        </div>
    </div>

    <button class="fab btn-config" onclick="toggleConfig(true)">‚öôÔ∏è</button>
    <button class="fab btn-locate" id="locate-btn" onclick="toggleGPS()">üéØ</button>
    <button class="fab btn-search" onclick="toggleSearch(true)">üîç</button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        // IMPORT FIREBASE LIBRARIES
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURA√á√ÉO REAL DO FIREBASE (EXEMPLO)
        const firebaseConfig = {
            apiKey: "AIzaSyD-9mGZUB4m_vuc8mAATPtpiQdinb4nYx0", // Token p√∫blico para exemplo
            authDomain: "radar-database-3448b.firebaseapp.com",
            projectId: "radar-database-3448b",
            storageBucket: "radar-database-3448b.appspot.com",
            messagingSenderId: "927242352551",
            appId: "1:927242352551:web:a980043e310d5dc1e2e882"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentTowerId = null;

        // --- SISTEMA DE LOGIN/LOGOUT ---

        window.handleLogin = async () => {
            showLoader("Authorizing...");
            try {
                const result = await signInWithPopup(auth, provider);
                showToast(`Welcome, ${result.user.displayName}`);
                toggleLogin(false);
            } catch (error) {
                showToast("Error: (auth/network-request-failed)");
            } finally {
                hideLoader();
            }
        };

        window.handleLogout = async () => {
            showLoader("Leaving...");
            setTimeout(async () => {
                await signOut(auth);
                hideLoader();
                toggleConfig(false);
                showToast("Account disconnected.");
            }, 1500);
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            document.getElementById('user-info').style.display = user ? 'block' : 'none';
            if (!user) {
                // Se n√£o estiver logado e tentar abrir chat, mostra bot√£o de login
                document.getElementById('chat-auth-check').style.display = 'block';
                document.getElementById('input-area').style.display = 'none';
            } else {
                document.getElementById('chat-auth-check').style.display = 'none';
                document.getElementById('input-area').style.display = 'flex';
            }
        });

        // --- L√ìGICA DO MAPA (MANTIDA) ---

        const map = L.map('map', { zoomControl: false }).setView([-15.78, -47.92], 4);
        const tileLayer = L.tileLayer('').addTo(map);
        const markersLayer = L.layerGroup().addTo(map);
        let watchId = null;

        window.alterarTema = (isDark) => {
            document.body.classList.toggle('dark-mode', isDark);
            tileLayer.setUrl(isDark ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        };

        window.analisarTags = (tags) => {
            const t = JSON.stringify(tags || {}).toLowerCase();
            let badges = [];
            if (t.includes("5g") || tags["communication:mobile_phone:generation:5g"] === "yes") badges.push('<span class="badge bg-5g">5G SA</span>');
            if (t.includes("lte") || t.includes("4g")) badges.push('<span class="badge bg-4g">4G LTE</span>');
            return { html: badges.join(''), operator: tags.operator || "Unknown Operator" };
        };

        window.carregarMapa = async () => {
            if(map.getZoom() < 14) { markersLayer.clearLayers(); return; }
            const b = map.getBounds();
            const q = `[out:json][timeout:15];(node["man_made"~"mast|tower"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out body;`;
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(q));
                const data = await res.json();
                data.elements.forEach(el => {
                    const info = analisarTags(el.tags);
                    L.marker([el.lat, el.lon], {icon: L.divIcon({html: '<div style="font-size:26px;">üóº</div>', className: ''})})
                     .addTo(markersLayer).on('click', () => toggleComments(true, el.id));
                });
            } catch(e) {}
        };

        // --- SISTEMA DE COMENT√ÅRIOS COM FIREBASE ---

        window.toggleComments = (show, towerId = null) => {
            const frame = document.getElementById('comment-frame');
            frame.classList.toggle('active', show);
            if(show && towerId) {
                currentTowerId = towerId.toString();
                document.getElementById('comm-tower-title').innerText = `Tower #${towerId}`;
                renderizarComentarios();
            }
        };

        window.renderizarComentarios = () => {
            const container = document.getElementById('comm-container');
            container.innerHTML = '<p style="text-align:center; opacity:0.5;">Loading community reports...</p>';

            const q = query(collection(db, "comments"), where("towerId", "==", currentTowerId), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                container.innerHTML = "";
                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align:center; opacity:0.5; padding:20px;">No comment for now.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const div = document.createElement('div');
                    div.style.cssText = "background:var(--item-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid var(--border-color);";
                    div.innerHTML = `<b style="color:var(--accent); font-size:12px;">${c.userName}</b><p style="margin:5px 0 0 0; font-size:14px;">${c.text}</p>`;
                    container.appendChild(div);
                });
            }, (error) => {
                container.innerHTML = `<p style="color:#ff3b30; text-align:center; padding:20px;">No permission to read the comments.<br><small>(Error: ${error.code})</small></p>`;
            });
        };

        window.postarComentario = async () => {
            const input = document.getElementById('comm-input');
            const text = input.value.trim();
            if(!text || !currentUser) return;

            try {
                await addDoc(collection(db, "comments"), {
                    towerId: currentTowerId,
                    text: text,
                    userName: currentUser.displayName,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                input.value = "";
            } catch(e) {
                showToast("Error sending comment.");
            }
        };

        // --- AUXILIARES UI ---

        function showLoader(text) {
            document.getElementById('loader-text').innerText = text;
            document.getElementById('loader-overlay').style.display = 'flex';
        }
        function hideLoader() { document.getElementById('loader-overlay').style.display = 'none'; }

        window.showToast = (msg) => {
            const t = document.getElementById('ios-toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3500);
        };

        window.toggleLogin = (s) => document.getElementById('login-overlay').style.display = s ? 'flex' : 'none';
        window.toggleTerms = (s) => document.getElementById('terms-overlay').style.display = s ? 'flex' : 'none';
        window.toggleConfig = (s) => document.getElementById('config-overlay').style.display = s ? 'flex' : 'none';
        window.toggleSearch = (s) => document.getElementById('search-overlay').style.display = s ? 'flex' : 'none';

        window.toggleGPS = () => {
            const btn = document.getElementById('locate-btn');
            if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; btn.style.background = 'var(--item-bg)'; }
            else {
                watchId = navigator.geolocation.watchPosition(p => {
                    map.setView([p.coords.latitude, p.coords.longitude], 16);
                });
                btn.style.background = 'var(--accent)';
            }
        };

        // INIT
        map.on('moveend', carregarMapa);
        alterarTema(true);
        
        // Verifica se tem token ao entrar
        setTimeout(() => {
            if(!auth.currentUser) toggleLogin(true);
        }, 1000);

    </script>
</body>
</html>
