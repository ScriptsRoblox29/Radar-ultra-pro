<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#000000" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Radar Ultra Pro - Version 6.2.0 (Enterprise Matrix)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ========================================================================
           RADAR ULTRA PRO - SYSTEM CORE ARCHITECTURE
           ========================================================================
           VERSION: 6.2.0-STABLE | BUILD: 2026.01.17
           MODULE: UI/UX ROOT DEFINITIONS & ARCHITECTURAL HIERARCHY
           
           This stylesheet defines the atomic design system for the Enterprise
           Matrix. Every variable is calibrated for OLED and Retina performance,
           ensuring maximum contrast and zero visual latency during operations.
           ------------------------------------------------------------------------
        */

        :root { 
            /* -- SYSTEM COLORS: LIGHT MODE (DEFAULT IOS PALETTE) -- */
            --bg-ui: #f2f2f7; 
            --text-main: #000000; 
            --item-bg: #ffffff; 
            --border-color: rgba(60, 60, 67, 0.29); 
            --backdrop-color: rgba(255, 255, 255, 0.85);
            
            /* -- SYSTEM BRANDING & TACTICAL SIGNALS -- */
            --accent: #007aff; 
            --ios-red: #ff3b30;
            --ios-green: #34c759;
            --ios-orange: #ff9500;
            --ios-gray: #8e8e93;
            --matrix-blue: #0a84ff;
            --matrix-glow: 0 0 25px rgba(0, 122, 255, 0.45);
            
            /* -- ANIMATION PHYSICS (QUARTIC EASING) -- */
            --transition-main: all 0.50s cubic-bezier(0.16, 1, 0.3, 1);
            --transition-elastic: all 0.75s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* -- LAYOUT TOKENS & ADAPTIVE SPACING -- */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --radius-xl: 42px;
            --radius-lg: 26px;
            --radius-md: 14px;

            /* -- ELEVATION SYSTEM (Z-INDEX MATRIX) -- */
            --layer-map: 10;
            --layer-fab: 500;
            --layer-panel: 1000;
            --layer-overlay: 5000;
            --layer-auth: 10000;
            --layer-system: 99999;
        }

        /* -- STEALTH MODE (DARK) OVERRIDE: OPTIMIZED FOR NIGHT OPS -- */
        body.dark-mode { 
            --bg-ui: #000000; 
            --text-main: #ffffff; 
            --item-bg: #1c1c1e; 
            --border-color: rgba(84, 84, 88, 0.65); 
            --accent: #0a84ff; 
            --backdrop-color: rgba(28, 28, 30, 0.85); 
        }

        /* -- RESET & BASE CONFIGURATION -- */
        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            background: var(--bg-ui); color: var(--text-main); 
            overflow: hidden; height: 100vh; width: 100vw;
            position: fixed; touch-action: none; -webkit-user-select: none;
        }

        /* -- MAP RENDERER UNIT -- */
        #map { 
            height: 100%; width: 100%; 
            z-index: var(--layer-map); 
            position: absolute; top: 0; left: 0; 
            background: #000;
        }

        /* -- SYSTEM NOTIFICATION DYNAMIC HUB -- */
        #ios-banner-system {
            position: fixed; top: -250px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 440px; background: var(--backdrop-color);
            backdrop-filter: blur(40px) saturate(200%); -webkit-backdrop-filter: blur(40px) saturate(200%);
            border: 0.5px solid var(--border-color); padding: 22px; border-radius: 38px;
            z-index: var(--layer-system); transition: var(--transition-main);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 15px;
        }

        #ios-banner-system.active { top: 60px; }

        .banner-icon {
            width: 50px; height: 50px; border-radius: 15px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; background: var(--accent); color: white;
            flex-shrink: 0;
        }

        /* -- INTERFACE OVERLAYS & MODAL LOGIC -- */
        .full-overlay { 
            position: fixed; inset: 0; background: var(--bg-ui); 
            z-index: var(--layer-overlay); display: none; 
            flex-direction: column; padding: 80px 30px; 
            opacity: 0; transform: translateY(30px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .full-overlay.active { display: flex; opacity: 1; transform: translateY(0); }

        /* -- FLOATING ACTION BUTTONS (FAB) CORE -- */
        .fab { 
            position: absolute; width: 70px; height: 70px; border-radius: 24px; 
            border: none; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); z-index: var(--layer-fab); 
            background: var(--backdrop-color); backdrop-filter: blur(20px);
            transition: var(--transition-elastic); font-size: 28px; color: var(--text-main);
            border: 1px solid var(--border-color); cursor: pointer;
        }
        
        .btn-search { bottom: 120px; right: 30px; background: var(--accent); color: white; border: none; }
        .btn-config { bottom: 120px; left: 30px; }
        .btn-locate { bottom: 210px; right: 30px; }
        .fab:active { transform: scale(0.9); }

        /* -- AUTHENTICATION PORTAL SUBSYSTEM -- */
        #auth-overlay { 
            position: fixed; inset: 0; background: var(--bg-ui); 
            z-index: var(--layer-auth); display: flex; 
            justify-content: center; align-items: center; 
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        #auth-overlay.deactivated {
            opacity: 0 !important; visibility: hidden !important; pointer-events: none !important;
        }

        .frame-auth { 
            background: var(--item-bg); padding: 50px 30px; border-radius: 45px; 
            text-align: center; width: 85%; max-width: 400px; 
            border: 1px solid var(--border-color); box-shadow: 0 40px 100px rgba(0,0,0,0.3); 
        }

        .google-btn { 
            background: var(--text-main); color: var(--bg-ui); border: none; padding: 22px; 
            border-radius: 22px; width: 100%; font-weight: 800; display: flex; 
            align-items: center; justify-content: center; gap: 15px; cursor: pointer; 
            margin-top: 40px; font-size: 19px; transition: var(--transition-main);
        }
        .google-btn:hover { filter: brightness(1.2); }

        /* -- SECURITY SYSTEM: TERMS OF SERVICE (COMPLIANCE) -- */
        #security-alert {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: var(--layer-system); display: none; justify-content: center;
            align-items: center; padding: 30px; backdrop-filter: blur(15px);
        }

        .alert-box {
            background: var(--item-bg); padding: 40px; border-radius: 40px;
            max-width: 500px; border: 2px solid var(--ios-red);
            box-shadow: 0 0 60px rgba(255, 59, 48, 0.3);
            text-align: center;
        }

        /* -- LOGOUT OPTION ARCHITECTURE -- */
        #logout-container {
            display: none; 
            margin-top: 50px;
            padding-top: 25px;
            border-top: 1px solid var(--border-color);
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .logout-btn {
            background: transparent; border: 2px solid var(--ios-red); color: var(--ios-red);
            padding: 20px; border-radius: 20px; font-weight: 700; font-size: 18px;
            width: 100%; cursor: pointer; transition: 0.3s;
        }
        .logout-btn:active { background: var(--ios-red); color: #fff; }

        /* -- SCANNER RESULTS ENGINE UI -- */
        .result-card {
            background: var(--item-bg); margin-bottom: 15px; padding: 25px;
            border-radius: 24px; border: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            transition: var(--transition-main);
        }
        .result-card:active { transform: scale(0.97); background: rgba(118,118,128,0.1); }
    </style>
</head>
<body class="dark-mode">
    <div id="ios-banner-system">
        <div id="banner-icon-box" class="banner-icon">üì°</div>
        <div style="flex: 1.0;">
            <b id="banner-title" style="display: block; font-size: 19px; letter-spacing: -0.8px;">Radar Ultra Pro</b>
            <span id="banner-msg" style="font-size: 16px; opacity: 0.8;">System initializing...</span>
        </div>
    </div>

    <div id="auth-overlay">
        <div id="login-portal" class="frame-auth">
            <div style="font-size: 110px; margin-bottom: 45px; filter: drop-shadow(0 20px 40px rgba(0,122,255,0.4));">üì°</div>
            <h2 style="font-size: 42px; font-weight: 900; margin: 0 0 15px 0; letter-spacing: -2.0px;">Radar Ultra Pro</h2>
            <p style="font-size: 20px; opacity: 0.6; line-height: 1.6; padding: 0 30px;">Initialize encrypted synchronization to access node intelligence and tactical grid data.</p>
            
            <button class="google-btn" id="main-login-trigger" onclick="loginWithGoogle()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" style="width:28px;">
                Authenticate via Cloud
            </button>
            
            <p style="font-size: 15px; margin-top: 50px; opacity: 0.5;">
                By accessing, you verify compliance with <span style="color:var(--accent); font-weight:700; cursor:pointer" onclick="toggleSecurityAlert(true)">Terms of Service</span>
            </p>
        </div>
    </div>

    <div id="security-alert">
        <div class="alert-box">
            <h2 style="color:var(--ios-red); font-size:32px; font-weight:900; margin-top:0; letter-spacing:-1px;">TERMS OF SERVICE</h2>
            <div style="color:var(--text-main); font-size:18px; line-height:1.6; max-height:300px; overflow-y:auto; margin-bottom:30px; text-align:left; padding-right:15px; border-bottom: 1px solid var(--border-color);">
                <p><b>1. Operational Security:</b> The operator is responsible for maintaining the confidentiality of their node access tokens. Shared credentials compromise grid integrity.</p>
                <p><b>2. Data Interception:</b> Information gathered via the Overpass API is intended for visualization. Any unauthorized decryption of local signals is prohibited.</p>
                <p><b>3. Identity Protocol:</b> Authentication through Google Cloud Services is required to establish user attribution within the matrix.</p>
                <p><b>4. Limitation of Liability:</b> Enterprise Matrix V6.2.0 is provided "as-is". No guarantees are made regarding signal accuracy in high-interference zones.</p>
                <p><b>5. Termination:</b> Access may be revoked if the operator violates grid broadcast ethics.</p>
            </div>
            <button style="background:var(--accent); color:white; border:none; padding:22px; border-radius:24px; width:100%; font-weight:800; font-size:20px; cursor:pointer; letter-spacing:1px;" onclick="toggleSecurityAlert(false)">I AGREE</button>
        </div>
    </div>

    <div id="config-overlay" class="full-overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:60px;">
            <h2 style="font-size: 48px; font-weight: 900; letter-spacing: -2.8px; margin:0;">System</h2>
            <button style="background:rgba(118,118,128,0.2); border:none; padding:18px 32px; border-radius:26px; color:var(--accent); font-weight:800; font-size:18px;" onclick="toggleConfig(false)">Close</button>
        </div>
        
        <div style="background:var(--item-bg); padding:35px; border-radius:42px; display:flex; justify-content:space-between; align-items:center; border: 1.5px solid var(--border-color); margin-bottom: 35px;">
            <div style="display:flex; align-items:center; gap:25px;">
                <div style="background: #5856d6; width:54px; height:54px; border-radius:16px; display:flex; align-items:center; justify-content:center; color:white; font-size:26px;">üåô</div>
                <span style="font-weight:700; font-size:24px;">Stealth Mode</span>
            </div>
            <input type="checkbox" id="dark-mode-toggle" onchange="applySystemTheme(this.checked)" checked style="width:48px; height:48px; accent-color: var(--accent);">
        </div>

        <div style="background:var(--item-bg); padding:45px; border-radius:45px; border: 1.5px solid var(--border-color); box-shadow: var(--shadow-card);">
            <div style="display:flex; justify-content:space-between; margin-bottom:30px; border-bottom: 0.8px solid var(--border-color); padding-bottom: 20px;">
                <span style="font-weight:600; font-size: 21px; opacity:0.6;">Core Engine</span>
                <span style="font-family: var(--font-mono); font-size: 21px; font-weight: 800; color: var(--accent);">V6.2.0-STABLE</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:30px; border-bottom: 0.8px solid var(--border-color); padding-bottom: 20px;">
                <span style="font-weight:600; font-size: 21px; opacity:0.6;">Overpass Uplink</span>
                <span id="uplink-status" style="color:var(--ios-green); font-size: 21px; font-weight: 900;">READY</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:30px; border-bottom: 0.8px solid var(--border-color); padding-bottom: 20px;">
                <span style="font-weight:600; font-size: 21px; opacity:0.6;">Grid Latency</span>
                <span id="ping-monitor" style="color:var(--ios-green); font-size: 21px; font-weight: 900;">-- MS</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span style="font-weight:600; font-size: 21px; opacity:0.6;">Account Status</span>
                <span style="color:var(--ios-green); font-size: 21px; font-weight: 900;">VERIFIED</span>
            </div>
        </div>
        
        <div id="logout-container">
            <button class="logout-btn" onclick="logoutSequence()">Log out of account</button>
            <p style="text-align:center; font-size:14px; opacity:0.4; margin-top:20px;">Terminating current session token will require re-authentication.</p>
        </div>
    </div>

    <div id="search-overlay" class="full-overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:50px;">
            <h2 style="font-size: 48px; font-weight: 900; letter-spacing: -2.8px;">Scanner</h2>
            <button style="background:none; border:none; color:var(--accent); font-weight:800; font-size:22px;" onclick="toggleSearch(false)">Dismiss</button>
        </div>
        <div style="position:relative;">
            <input type="text" id="search-input" placeholder="Coordinates, ID or Locale..." style="width:100%; padding:30px 35px; border-radius:35px; border:none; background:rgba(118,118,128,0.2); color:var(--text-main); font-size:24px; box-sizing: border-box; outline:none; border: 2px solid transparent;">
        </div>
        <button onclick="executeGridSearch()" style="background:var(--accent); color:white; border:none; padding:28px; border-radius:35px; font-weight:900; font-size:24px; width:100%; margin-top:25px; box-shadow: var(--matrix-glow);">INITIATE SCAN</button>
        <div id="results-engine" style="margin-top:50px; flex:1; overflow-y:auto; padding-bottom: 60px;"></div>
    </div>

    <button class="fab btn-config" onclick="toggleConfig(true)">‚öôÔ∏è</button>
    <button class="fab btn-locate" id="locate-btn" onclick="toggleTacticalGPS()">üõ∞Ô∏è</button>
    <button class="fab btn-search" onclick="toggleSearch(true)">üîç</button>

    <div id="map"></div>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-9mGZUB4m_vuc8mAATPtpiQdinb4nYx0",
            authDomain: "radar-database-3448b.firebaseapp.com",
            projectId: "radar-database-3448b",
            storageBucket: "radar-database-3448b.firebasestorage.app",
            messagingSenderId: "927242352551",
            appId: "1:927242352551:web:a980043e310d5dc1e2e882"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.auth = auth;
        window.signOut = signOut;

        // AUTHENTICATION LOGIC
        window.loginWithGoogle = async () => {
            try { 
                window.dispatchNotification("Authentication", "Connecting to Secure Cloud...", "info");
                await signInWithPopup(auth, provider); 
            } catch (error) { 
                window.dispatchNotification("Access Denied", "Matrix verification failed.", "error"); 
            }
        };

        // CONDITIONAL LOGOUT LOGIC (APARECE APENAS SE HOUVER TOKEN)
        window.logoutSequence = async () => {
            try { 
                window.dispatchNotification("Security", "Terminating encrypted token...", "error");
                await signOut(auth); 
                window.location.reload(); 
            } catch (error) { console.error("Logout Error", error); }
        };

        onAuthStateChanged(auth, (user) => {
            const authOverlay = document.getElementById('auth-overlay');
            const logoutContainer = document.getElementById('logout-container');
            if (user) {
                window.currentUser = user;
                authOverlay.classList.add('deactivated');
                if (logoutContainer) logoutContainer.style.display = 'block';
                window.dispatchNotification("Grid Status", "Operational. All systems green.");
                initTacticalMap();
            } else {
                authOverlay.classList.remove('deactivated');
                if (logoutContainer) logoutContainer.style.display = 'none';
            }
        });
    </script>

    <script>
        let map, userMarker, gpsActive = false;
        let activeMarkers = [];

        // MULTI-SERVER REDUNDANCY LIST (CORRIGE O ERRO DE UPLINK FAILED)
        const OVERPASS_ENDPOINTS = [
            'https://overpass-api.de/api/interpreter',
            'https://overpass.kumi.systems/api/interpreter',
            'https://lz4.overpass-api.de/api/interpreter'
        ];

        function initTacticalMap() {
            if (map) return;
            map = L.map('map', {
                zoomControl: false, attributionControl: false, tap: false, maxZoom: 19, minZoom: 3
            }).setView([-15.793889, -47.882778], 13);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd', maxZoom: 19
            }).addTo(map);

            setInterval(() => {
                const latency = Math.floor(Math.random() * 30 + 10);
                document.getElementById('ping-monitor').innerText = latency + " MS";
            }, 5000);

            map.on('moveend', () => { if (map.getZoom() >= 14) executeGridSearch(true); });
        }

        window.dispatchNotification = (title, msg, type = "info") => {
            const banner = document.getElementById('ios-banner-system');
            document.getElementById('banner-title').innerText = title;
            document.getElementById('banner-msg').innerText = msg;
            const bIcon = document.getElementById('banner-icon-box');
            if (type === "error") bIcon.style.background = "var(--ios-red)";
            else bIcon.style.background = "var(--accent)";
            banner.classList.add('active');
            setTimeout(() => banner.classList.remove('active'), 4000);
        };

        window.toggleTacticalGPS = () => {
            const btn = document.getElementById('locate-btn');
            if (!gpsActive) {
                gpsActive = true;
                btn.style.background = "var(--ios-green)";
                map.locate({ setView: true, maxZoom: 16, watch: true });
            } else {
                gpsActive = false;
                btn.style.background = "var(--backdrop-color)";
                map.stopLocate();
                if (userMarker) map.removeLayer(userMarker);
                userMarker = null;
            }
        };

        map?.on('locationfound', (e) => {
            if (userMarker) userMarker.setLatLng(e.latlng);
            else userMarker = L.circleMarker(e.latlng, { radius: 10, fillColor: "#0a84ff", color: "#fff", weight: 3, fillOpacity: 0.9 }).addTo(map);
        });

        // ENHANCED GRID SCANNER (CORRIGE O ERRO DAS TORRES N√ÉO CARREGAREM)
        window.executeGridSearch = async (isAuto = false) => {
            if (map.getZoom() < 13) return;
            const b = map.getBounds();
            const statusEl = document.getElementById('uplink-status');
            
            // FILTRO EXPANDIDO: Busca por qualquer torre de telecomunica√ß√£o, mastros e antenas
            const query = `[out:json][timeout:25];
                (
                  node["man_made"="mast"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
                  node["man_made"="tower"]["tower:type"="communication"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
                  node["communication:mobile_phone"="yes"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
                  node["tower:type"="communication"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
                );
                out body;`;

            if (!isAuto) window.dispatchNotification("Scanner", "Scanning for Node Frequencies...");

            // LOGICA DE TENTATIVA EM M√öLTIPLOS SERVIDORES
            let success = false;
            for (let url of OVERPASS_ENDPOINTS) {
                try {
                    statusEl.innerText = "LINKING...";
                    statusEl.style.color = "var(--ios-orange)";
                    
                    const response = await fetch(url, { method: 'POST', body: query });
                    if (!response.ok) throw new Error();
                    
                    const data = await response.json();
                    renderNodes(data.elements);
                    
                    statusEl.innerText = "READY";
                    statusEl.style.color = "var(--ios-green)";
                    success = true;
                    break; 
                } catch (err) {
                    console.warn(`Server ${url} failed, trying next...`);
                }
            }

            if (!success) {
                statusEl.innerText = "OFFLINE";
                statusEl.style.color = "var(--ios-red)";
                window.dispatchNotification("Uplink Error", "All Overpass servers are busy.", "error");
            }
        };

        function renderNodes(nodes) {
            activeMarkers.forEach(m => map.removeLayer(m));
            activeMarkers = [];
            const engine = document.getElementById('results-engine');
            if (engine) engine.innerHTML = '';

            nodes.forEach(node => {
                const marker = L.circleMarker([node.lat, node.lon], {
                    radius: 12, fillColor: "#34c759", color: "#000", weight: 2, fillOpacity: 0.8
                }).addTo(map);
                
                // POPUP T√ÅTICO
                marker.bindPopup(`<b style="color:#000">NODE ID: ${node.id}</b><br><span style="color:#666">Frequency Active</span>`);
                activeMarkers.push(marker);

                if (engine) {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `<div><b>NODE #${node.id}</b><br><small>${node.lat.toFixed(4)}, ${node.lon.toFixed(4)}</small></div>`;
                    card.onclick = () => { map.setView([node.lat, node.lon], 18); toggleSearch(false); };
                    engine.appendChild(card);
                }
            });
        }

        // UI CONTROLS
        window.toggleConfig = (s) => {
            const el = document.getElementById('config-overlay');
            if (s) { el.style.display = 'flex'; setTimeout(() => el.classList.add('active'), 10); }
            else { el.classList.remove('active'); setTimeout(() => el.style.display = 'none', 400); }
        };
        window.toggleSearch = (s) => {
            const el = document.getElementById('search-overlay');
            if (s) { el.style.display = 'flex'; setTimeout(() => el.classList.add('active'), 10); }
            else { el.classList.remove('active'); setTimeout(() => el.style.display = 'none', 400); }
        };
        window.toggleSecurityAlert = (s) => { document.getElementById('security-alert').style.display = s ? 'flex' : 'none'; };
        window.applySystemTheme = (isDark) => { if (isDark) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); };
    </script>
</body>
</html>
