<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Radar Ultra Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            /* Padr√£o: Modo Claro (Desativado) */
            --ios-bg: #f2f2f7; --ios-item: #ffffff; --ios-text: #000000;
            --ios-blue: #007aff; --ios-red: #ff3b30; --ios-gray: #8e8e93;
            --map-filter: none;
        }
        body.dark-mode {
            --ios-bg: #000000; --ios-item: #1c1c1e; --ios-text: #ffffff;
            --ios-gray: #48484a;
            --map-filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--ios-bg); color: var(--ios-text); overflow: hidden; width: 100vw; transition: background 0.3s; }
        #map { height: 100vh; width: 100%; z-index: 1; filter: var(--map-filter); transition: filter 0.3s; }

        /* FRAMES */
        .ios-frame { position: fixed; top: 0; left: 0; width: 100vw; height: 100%; background: var(--ios-bg); z-index: 10000; display: none; flex-direction: column; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow-x: hidden; }
        .ios-frame.active { display: flex; transform: translateY(0); }
        /* Removida anima√ß√£o slideUp separada para usar a transition de transform no fechar tamb√©m */

        /* GOOGLE ICON (SVG OFICIAL) */
        .g-btn { background: white; color: #3c4043; border: 1px solid #dadce0; padding: 12px 20px; border-radius: 12px; font-weight: 600; display: flex; align-items: center; gap: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 16px; margin: 20px auto; width: fit-content; }
        .g-logo-svg { width: 18px; height: 18px; }

        /* TOAST & LOADER */
        .toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(28,28,30,0.9); backdrop-filter: blur(15px); color: white; padding: 16px; border-radius: 20px; z-index: 50000; transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); text-align: center; }
        .toast.show { top: 60px; }
        .loader { width: 24px; height: 24px; border: 3px solid var(--ios-gray); border-top-color: var(--ios-blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MARKERS */
        .tower-dot { width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .dot-data { background: #34c759; } 
        .dot-tv { background: #af52de; }   

        /* CHAT UI */
        #chat-frame { border-radius: 30px 30px 0 0; height: 92vh; top: 8vh; }
        .chat-header { padding: 20px; border-bottom: 0.5px solid var(--ios-gray); display: flex; justify-content: space-between; align-items: center; }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px; }
        .chat-input-bar { padding: 15px 15px calc(15px + env(safe-area-inset-bottom)) 15px; background: var(--ios-item); border-top: 0.5px solid var(--ios-gray); display: flex; gap: 10px; }
        
        .btn-close-circle { width: 32px; height: 32px; background: var(--ios-gray); border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: none; background: var(--ios-bg); color: var(--ios-text); font-size: 16px; outline: none; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body class=""> <div id="toast" class="toast"></div>

    <div id="login-frame" class="ios-frame" style="display: flex; align-items: center; justify-content: center; text-align: center; padding: 30px;">
        <button class="btn-close-circle" style="position: absolute; top: 50px; right: 20px;" onclick="toggleFrame('login-frame', false)">‚úï</button>
        <div style="font-size: 60px;">üóº</div>
        <p style="font-size: 19px; font-weight: 600; margin: 20px 0;">Welcome!</p>
        <p style="font-size: 16px; opacity: 0.8;">Log in so you can see community comments and comment on towers.</p>
        <button class="g-btn" onclick="signIn()">
            <svg class="g-logo-svg" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 12-4.53z" fill="#EA4335"/></svg>
            Continue with Google
        </button>
        <p style="font-size: 12px; color: var(--ios-gray); cursor: pointer;" onclick="toggleFrame('terms-frame', true)">By continuing, you agree to our terms of service.</p>
    </div>
        <div id="terms-frame" class="ios-frame" style="padding: 60px 20px;">
        <button class="btn-close-circle" onclick="toggleFrame('terms-frame', false)">‚Üê</button>
        <h2 style="margin: 20px 0;">Terms of Service</h2>
        <div style="line-height: 1.6; opacity: 0.9;">
            <p>1. We will never store your location; it will only be processed on your device.</p>
            <p>2. Your Google account data will be stored on our server called Firebase, created by Google.</p>
            <p>3. Offensive, illegal, spam, or false information comments are not allowed; your account will be permanently deactivated.</p>
            <p><b>Attempting to take down our website is not allowed; it is illegal.</b></p>
        </div>
    </div>

    <div id="settings-frame" class="ios-frame" style="padding: 60px 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2 style="margin:0;">Settings</h2>
            <button class="btn-close-circle" onclick="toggleFrame('settings-frame', false)">‚úï</button>
        </div>
        <div style="background:var(--ios-item); border-radius:14px; width:100%; overflow:hidden;">
            <div style="padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:0.5px solid var(--ios-gray);">
                <span>Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="dark-toggle" onclick="toggleDarkMode()">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="profile-btn" style="padding:15px; display:flex; justify-content:space-between;" onclick="showProfile()"><span>About the profile</span><span>‚Ä∫</span></div>
        </div>
    </div>

    <div id="chat-frame" class="ios-frame">
        <div class="chat-header">
            <span id="chat-tower-id" style="font-weight:600; font-size:12px; opacity:0.5;">ID: --</span>
            <button class="btn-close-circle" onclick="toggleFrame('chat-frame', false)">‚úï</button>
        </div>
        <div id="chat-loading" class="loader"></div>
        <div id="chat-list" class="chat-list"></div>
        <div class="chat-input-bar">
            <input type="text" id="comm-input" maxlength="100" placeholder="Min. 10 characters..." oninput="checkInput()">
            <button id="btn-send" disabled onclick="sendComment()" style="background:none; border:none; color:var(--ios-blue); font-weight:700; font-size:16px; opacity:0.3;">Send</button>
        </div>
    </div>

    <button onclick="toggleFrame('settings-frame', true)" style="position:fixed; bottom:30px; left:20px; z-index:1000; width:54px; height:54px; border-radius:50%; background:var(--ios-item); border:none; font-size:24px; box-shadow:0 4px 15px rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center;">‚öôÔ∏è</button>
    <button onclick="getMyPos()" style="position:fixed; bottom:30px; right:20px; z-index:1000; width:54px; height:54px; border-radius:50%; background:var(--ios-item); border:none; font-size:24px; box-shadow:0 4px 15px rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center;">üéØ</button>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-9mGZUB4m_vuc8mAATPtpiQdinb4nYx0",
            authDomain: "radar-database-3448b.firebaseapp.com",
            projectId: "radar-database-3448b",
            storageBucket: "radar-database-3448b.appspot.com",
            messagingSenderId: "927242352551",
            appId: "1:927242352551:web:a980043e310d5dc1e2e882"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentTowerId = null;
        let unsubscribeChat = null;

        window.toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                if (!snap.exists()) await setDoc(userRef, { commentCount: 0, likes: 0 });
            }
        });

        window.signIn = async () => {
            try {
                await signInWithPopup(auth, provider);
                toggleFrame('login-frame', false);
                showToast("Connected successfully");
            } catch (e) { showToast("Login Error: " + e.code); }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                const p = document.getElementById('profile-frame');
                if(p) p.remove();
                toggleFrame('settings-frame', false);
                showToast("Successfully disconnected");
            } catch (e) { showToast("Error"); }
        };

        const map = L.map('map', { zoomControl: false, tap: false }).setView([-15.78, -47.92], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markersLayer = L.layerGroup().addTo(map);

        window.carregarTorres = async () => {
            if (map.getZoom() < 14) { markersLayer.clearLayers(); return; }
            const b = map.getBounds();
            const q = `[out:json][timeout:25];(node["man_made"~"mast|tower"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out body;`;
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(q));
                const data = await res.json();
                markersLayer.clearLayers();
                data.elements.forEach(el => {
                    const isTV = (el.tags?.service === 'television' || el.tags?.['tower:type'] === 'communication');
                    const color = isTV ? 'dot-tv' : 'dot-data';
                    let tags = "";
                    ["5G", "4G", "3G", "LTE"].forEach(t => { if (JSON.stringify(el.tags).includes(t)) tags += `<span style="background:var(--ios-blue);color:white;padding:2px 5px;border-radius:4px;font-size:10px;margin-right:3px;">${t}+</span>`; });
                    const marker = L.marker([el.lat, el.lon], { icon: L.divIcon({ className: `tower-dot ${color}` }) }).addTo(markersLayer);
                    marker.bindPopup(`<div style="color:black; min-width:160px;"><b>${isTV ? 'TV Tower' : 'Mobile Tower'}</b><br><small>ID: ${el.id}</small><br><button onclick="openChat('${el.id}')" style="width:100%; background:var(--ios-blue); color:white; border:none; padding:10px; border-radius:8px; margin-top:10px; font-weight:bold;">Comments</button></div>`);
                });
            } catch (e) { console.error(e); }
        };

        window.openChat = (id) => {
            currentTowerId = id;
            document.getElementById('chat-tower-id').innerText = `TOWER ID: ${id}`;
            toggleFrame('chat-frame', true);
            loadComments(id);
        };

        function loadComments(id) {
            const list = document.getElementById('chat-list');
            const loader = document.getElementById('chat-loading');
            loader.style.display = 'block';
            list.innerHTML = "";
            if (unsubscribeChat) unsubscribeChat();
            const q = query(collection(db, "comments"), where("towerId", "==", id), orderBy("createdAt", "desc"));
            unsubscribeChat = onSnapshot(q, (snaps) => {
                loader.style.display = 'none';
                list.innerHTML = "";
                snaps.forEach(d => {
                    const c = d.data();
                    const item = document.createElement('div');
                    item.style = "background:var(--ios-item); padding:12px; border-radius:16px; margin-bottom:12px; display:flex; gap:12px;";
                    item.innerHTML = `<img src="${c.userPhoto}" style="width:36px; height:36px; border-radius:50%;"><div style="flex:1;"><b>${c.username}</b><p style="margin:4px 0;">${c.text}</p></div>`;
                    list.appendChild(item);
                });
            });
        }

        window.sendComment = async () => {
            if (!currentUser) return showToast("Login required");
            const input = document.getElementById('comm-input');
            const text = input.value.trim();
            try {
                await addDoc(collection(db, "comments"), { towerId: currentTowerId, text, userId: currentUser.uid, username: currentUser.displayName, userPhoto: currentUser.photoURL, createdAt: serverTimestamp(), likes: 0 });
                input.value = "";
            } catch (e) { showToast("Error"); }
        };

        window.toggleFrame = (id, show) => {
            const f = document.getElementById(id);
            if(show) { f.style.display = 'flex'; setTimeout(() => f.classList.add('active'), 10); }
            else { f.classList.remove('active'); setTimeout(() => { if(!f.classList.contains('active')) f.style.display = 'none'; }, 400); }
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        window.checkInput = () => {
            const val = document.getElementById('comm-input').value.trim();
            const btn = document.getElementById('btn-send');
            const valid = val.length >= 10 && val.length <= 100;
            btn.disabled = !valid; btn.style.opacity = valid ? "1" : "0.3";
        };

        window.getMyPos = () => {
            navigator.geolocation.getCurrentPosition((p) => map.setView([p.coords.latitude, p.coords.longitude], 16));
        };

        window.showProfile = async () => {
            if(!currentUser) return showToast("Log in first");
            const snap = await getDoc(doc(db, "users", currentUser.uid));
            const data = snap.data();
            const html = `<div id="profile-frame" class="ios-frame active" style="padding:60px 20px;"><button class="btn-close-circle" onclick="this.parentElement.remove()">‚Üê</button><div style="text-align:center;"><img src="${currentUser.photoURL}" style="width:90px; border-radius:50%;"><h3>${currentUser.displayName}</h3><p>Comments: ${data?.commentCount || 0}</p></div><button onclick="handleLogout()" style="width:100%; padding:15px; background:var(--ios-red); color:white; border-radius:12px; border:none; margin-top:20px;">Log-out</button></div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        map.on('moveend', carregarTorres);
        setTimeout(() => toggleFrame('login-frame', true), 1500);
    </script>
</body>
</html>

