<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Radar Ultra Pro - Firebase Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --bg-ui: #f2f2f7; --text-main: #000000; --item-bg: #ffffff; --border-color: #c6c6c8; --accent: #007aff; --blur-bg: rgba(255, 255, 255, 0.85); }
        body.dark-mode { --bg-ui: #000000; --text-main: #ffffff; --item-bg: #1c1c1e; --border-color: #38383a; --accent: #0a84ff; --blur-bg: rgba(30, 30, 30, 0.85); }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: var(--bg-ui); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* UI GERAL */
        button { font-family: inherit; -webkit-tap-highlight-color: transparent; }
        .loader-inline { width: 24px; height: 24px; border: 3px solid var(--border-color); border-bottom-color: var(--accent); border-radius: 50%; display: inline-block; animation: rotation 0.8s linear infinite; margin: 20px auto; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* BADGES */
        .badge-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; }
        .bg-5g { background: linear-gradient(135deg, #5856d6, #007aff); }
        .bg-4g-plus { background: #34c759; }
        .bg-4g { background: #32d74b; }
        .bg-3g { background: #ff9500; }
        .bg-2g { background: #8e8e93; }
        
        /* OVERLAYS (IOS STYLE) */
        #search-overlay, #config-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-ui); z-index: 9999; display: none; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .search-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .search-header h2 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; margin: 0; }
        .search-container { width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; height: 100%; }
        
        /* INPUTS */
        input[type="text"] { width: 100%; padding: 12px 16px; border-radius: 12px; border: none; background: rgba(118, 118, 128, 0.12); color: var(--text-main); font-size: 17px; margin-bottom: 12px; outline: none; box-sizing: border-box; }
        input[type="text"]:focus { background: rgba(118, 118, 128, 0.2); }
        
        #results-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .result-item { background: var(--item-bg); padding: 16px; margin-bottom: 12px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        
        /* BOT√ïES FLUTUANTES (IOS 18 ICONS) */
        .fab { position: absolute; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; transition: transform 0.2s, background 0.2s; backdrop-filter: blur(10px); }
        .fab svg { width: 24px; height: 24px; fill: currentColor; }
        .fab:active { transform: scale(0.92); }
        
        .btn-search { bottom: 30px; right: 20px; background: var(--accent); color: white; width: 56px; height: 56px; }
        .btn-config { bottom: 30px; left: 20px; background: var(--item-bg); color: var(--text-main); }
        .btn-locate { bottom: 100px; right: 20px; background: var(--item-bg); color: var(--text-main); }
        .btn-locate.active { background: var(--accent); color: white; }

        /* BOT√ïES GERAIS */
        .btn-main { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 16px; width: 100%; cursor: pointer; transition: opacity 0.2s; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-view { background: rgba(118, 118, 128, 0.1); color: var(--accent); padding: 6px 14px; border-radius: 14px; border: none; font-weight: 600; font-size: 13px; cursor: pointer; }
        .btn-close-overlay { background: rgba(118, 118, 128, 0.12); width: 30px; height: 30px; border-radius: 50%; border: none; color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 14px; }

        /* CHAT SLIDE UP (TIKTOK STYLE) */
        #comment-frame { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10005; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        .chat-overlay-bg { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s; pointer-events: auto; display: none; }
        .chat-sheet { background: var(--bg-ui); width: 100%; height: 75vh; border-radius: 24px 24px 0 0; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); pointer-events: auto; box-shadow: 0 -5px 30px rgba(0,0,0,0.1); overflow: hidden; }
        
        #comment-frame.active .chat-overlay-bg { opacity: 1; display: block; }
        #comment-frame.active .chat-sheet { transform: translateY(0); }

        .comm-header { padding: 18px 20px; background: var(--blur-bg); backdrop-filter: blur(20px); border-bottom: 0.5px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; z-index: 2; }
        .comm-header h3 { font-size: 17px; font-weight: 600; margin: 0; }
        .comm-list { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        .comm-item { background: var(--item-bg); padding: 14px; border-radius: 18px 18px 18px 4px; margin-bottom: 12px; font-size: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); max-width: 85%; }
        .comm-date { font-size: 11px; opacity: 0.5; margin-top: 6px; display: block; text-align: right; }
        .comm-input-area { padding: 10px 16px 30px 16px; border-top: 0.5px solid var(--border-color); display: flex; gap: 10px; background: var(--item-bg); align-items: center; }
        
        /* NEW STYLES: AUTH AND SECURITY OVERLAYS */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-ui); z-index: 20000; display: flex; justify-content: center; align-items: center; }
        .frame-auth { background: var(--item-bg); padding: 24px; border-radius: 20px; text-align: center; width: 310px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .google-btn { background: var(--text-main); color: var(--bg-ui); border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; margin-top: 20px; }
        .google-btn img { width: 18px; height: 18px; }
        
        #security-alert { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 30000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .alert-box { background: var(--item-bg); padding: 24px; border-radius: 24px; max-width: 450px; border: 2px solid #ff3b30; text-align: left; }
        .danger-red { color: #ff3b30; font-weight: bold; }
        .btn-proceed-locked { background: #3a3a3c; color: #8e8e93; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: bold; cursor: not-allowed; }
        .btn-proceed-unlocked { background: #ff3b30; color: white; cursor: pointer; }

        /* MSG ERROR / INFO */
        .msg-status { text-align: center; color: var(--text-main); opacity: 0.6; font-size: 14px; margin-top: 30px; }
    </style>
</head>
<body class="dark-mode">

    <div id="auth-overlay">
        <div id="login-frame" class="frame-auth">
            <p style="font-weight:600;">Sign in to access real-time tower data and community reports.</p>
            <button class="google-btn" onclick="loginWithGoogle()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google">
                Continue with Google
            </button>
            <p id="auth-error-msg" style="color:#ff3b30; font-size:12px; margin-top:10px; display:none;"></p>
            <p style="font-size: 11px; margin-top: 20px; opacity: 0.7;">By signing in, you agree to our <span style="color:var(--accent); cursor:pointer" onclick="toggleToS(true)">Terms of Service</span>.</p>
        </div>

        <div id="tos-frame" class="frame-auth" style="display:none; text-align:left;">
            <button onclick="toggleToS(false)" style="background:none; border:none; color:var(--accent); padding:0; margin-bottom:10px; font-weight:bold;">‚Üê Back</button>
            <div style="font-size:12px; line-height:1.4; max-height: 300px; overflow-y: auto;">
                <h3 style="margin-top:0;">Terms of Service</h3>
                <p>1. We do not store your GPS history. Location data is processed locally on your device.</p>
                <p>2. Your Google profile data (Name and ID) is stored on Firebase (Google Infrastructure) to enable chat features.</p>
                <p>3. Your name will be partially masked (e.g., John ***) when you post public reports.</p>
                <p>4. You agree not to use this tool for illegal activities or to spam tower reports.</p>
            </div>
        </div>

        <div id="loading-frame" class="frame-auth" style="display:none;">
            <div class="loader-inline"></div>
            <p>Authenticating...</p>
        </div>
    </div>

    <div id="security-alert">
        <div class="alert-box">
            <h2 class="danger-red" style="margin-top:0;">Warning: External Link</h2>
            <p>You are attempting to visit: <span id="malicious-url-display" style="color:var(--accent); word-break:break-all;"></span></p>
            <p><span class="danger-red">Potential Risks:</span> Phishing, malware, and unauthorized data access.</p>
            <p style="font-size:13px;">Proceed only if you trust the source. We are not responsible for external content.</p>
            <p style="font-size:12px; opacity:0.8; border-left:3px solid #ff9500; padding-left:10px; margin: 15px 0;">
                Safety Tip: If this link was posted as spam, report it to the moderators or via TikTok (@fmafioso).
            </p>
            <button id="btn-proceed-risk" class="btn-proceed-locked" disabled>Wait (10s)...</button>
            <button onclick="closeSecurityAlert()" style="background:none; border:none; color:var(--accent); width:100%; margin-top:15px; font-weight:bold; cursor:pointer;">Return to Safety</button>
        </div>
    </div>

    <div id="config-overlay">
        <div class="search-container">
            <div class="search-header">
                <h2>Settings</h2>
                <button class="btn-close-overlay" onclick="toggleConfig(false)">‚úï</button>
            </div>
            <div style="background:var(--item-bg); padding:16px; border-radius:14px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:600; font-size:16px;">Dark Mode</span>
                <input type="checkbox" id="dark-mode-toggle" onchange="alterarTema(this.checked)" style="width:20px; height:20px;">
            </div>
        </div>
    </div>
    <div id="search-overlay">
        <div class="search-container">
            <div class="search-header">
                <h2>Search</h2>
                <button class="btn-close-overlay" onclick="toggleSearch(false)">‚úï</button>
            </div>
            <input type="text" id="search-input" placeholder="City, zip or coordinates...">
            <button class="btn-main" onclick="realizarPesquisa()" id="btn-search-action" style="margin-bottom:20px;">SEARCH AREA</button>
            <div id="results-list">
                <div style="text-align:center; padding:40px; opacity:0.5;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom:10px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <br>Enter a location to find towers.
                </div>
            </div>
        </div>
    </div>

    <div id="comment-frame">
        <div class="chat-overlay-bg" onclick="toggleComments(false)"></div>
        <div class="chat-sheet">
            <div class="comm-header">
                <h3 id="comm-tower-title">Tower Chat</h3>
                <button class="btn-close-overlay" onclick="toggleComments(false)">‚úï</button>
            </div>
            <div class="comm-list" id="comm-container">
                </div>
            <div class="comm-input-area">
                <input type="text" id="comm-input" placeholder="Add report (10-100 chars)..." style="margin:0; border-radius:20px;">
                <button class="btn-main" id="btn-send-comm" style="width:auto; padding:10px 20px; border-radius:20px;" onclick="enviarComentarioFirebase()" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

    <button class="fab btn-config" onclick="toggleConfig(true)">
        <svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.45l-.38 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.39 1.06.74 1.69.98l.38 2.65c.03.27.24.44.5.44h4c.25 0 .46-.17.5-.44l.37-2.65c.63-.24 1.17-.59 1.69-.98l2.49 1c.22.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66z"></path></svg>
    </button>
    <button class="fab btn-locate" id="locate-btn" onclick="toggleGPS()">
        <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path></svg>
    </button>
    <button class="fab btn-search" onclick="toggleSearch(true)">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
    </button>

    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-9mGZUB4m_vuc8mAATPtpiQdinb4nYx0",
            authDomain: "radar-database-3448b.firebaseapp.com",
            projectId: "radar-database-3448b",
            storageBucket: "radar-database-3448b.firebasestorage.app",
            messagingSenderId: "927242352551",
            appId: "1:927242352551:web:a980043e310d5dc1e2e882",
            measurementId: "G-6D091J9BG6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.getDocs = getDocs;
        window.Timestamp = Timestamp;

        let currentUser = null;

        // AUTH LOGIC
        window.loginWithGoogle = async () => {
            document.getElementById('login-frame').style.display = 'none';
            document.getElementById('loading-frame').style.display = 'block';
            try {
                await signInWithPopup(auth, provider);
            } catch (e) {
                document.getElementById('login-frame').style.display = 'block';
                document.getElementById('loading-frame').style.display = 'none';
                document.getElementById('auth-error-msg').innerText = "Login failed. Try again.";
                document.getElementById('auth-error-msg').style.display = 'block';
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('login-frame').style.display = 'block';
                document.getElementById('loading-frame').style.display = 'none';
            }
        });

        window.getCurrentUserName = () => {
            if (!currentUser) return "Anonymous";
            const name = currentUser.displayName || "User";
            const parts = name.split(" ");
            return parts[0] + " ***"; // Privacy Masking
        };
    </script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([-15.78, -47.92], 4);
        const tileLayer = L.tileLayer('').addTo(map);
        const markersLayer = L.layerGroup().addTo(map);
        let currentTowerId = null;
        let watchId = null;
        let userMarker = null;

        function alterarTema(isDark) {
            document.body.classList.toggle('dark-mode', isDark);
            const url = isDark 
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' 
                : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            tileLayer.setUrl(url);
            localStorage.setItem('radar_theme', isDark);
        }

        function analisarTags(tags) {
            const t = JSON.stringify(tags || {}).toLowerCase();
            let badges = [];
            let score = 0;
            let mbps = "Unknown";
            if (t.includes("5g") || t.includes("nr") || tags["communication:mobile_phone:generation:5g"] === "yes") {
                badges.push('<span class="badge bg-5g">5G SA/NSA</span>'); score += 1000; mbps = "300-1000 Mbps";
            }
            if (t.includes("lte") || t.includes("4g") || tags["communication:mobile_phone"] === "yes") {
                if(score > 0) badges.push('<span class="badge bg-4g-plus">4G+</span>');
                else { badges.push('<span class="badge bg-4g">4G LTE</span>'); mbps = "50-150 Mbps"; score += 100; }
            }
            if (t.includes("umts") || t.includes("hspa") || t.includes("3g")) {
                badges.push('<span class="badge bg-3g">H+ / 3G</span>'); if(score < 100) mbps = "5-20 Mbps";
            }
            if (t.includes("gsm") || t.includes("edge") || t.includes("2g")) {
                badges.push('<span class="badge bg-2g">2G / EDGE</span>'); if(score < 10) mbps = "0.1 Mbps";
            }
            if (badges.length === 0) { badges.push('<span class="badge bg-4g">4G (Probable)</span>'); }
            return { html: badges.join(''), score, mbps, operator: tags.operator || tags.brand || "Unknown Operator" };
        }

        async function realizarPesquisa() {
            const input = document.getElementById('search-input');
            const btn = document.getElementById('btn-search-action');
            const list = document.getElementById('results-list');
            if (!input.value) return;

            btn.disabled = true; btn.innerText = "SCANNING...";
            list.innerHTML = '<div style="text-align:center"><div class="loader-inline"></div><br>Triangulating towers...</div>';

            try {
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input.value)}&limit=1`);
                const geoData = await geoRes.json();
                if (!geoData.length) throw new Error("Location not found");
                
                const lat = parseFloat(geoData[0].lat);
                const lon = parseFloat(geoData[0].lon);
                const radius = 0.05;
                const query = `[out:json][timeout:15];(node["man_made"~"mast|tower"](${lat-radius},${lon-radius},${lat+radius},${lon+radius});node["communication:mobile_phone"="yes"](${lat-radius},${lon-radius},${lat+radius},${lon+radius}););out body;`;

                const towerRes = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
                const towerData = await towerRes.json();

                list.innerHTML = "";
                if(!towerData.elements.length) {
                    list.innerHTML = '<div class="msg-status">No signal towers found in this area.</div>';
                    return;
                }

                towerData.elements.forEach(tower => {
                    const info = analisarTags(tower.tags);
                    const el = document.createElement('div');
                    el.className = 'result-item';
                    el.innerHTML = `
                        <div class="tower-info"><h3>${info.operator}</h3><div class="badge-container">${info.html}</div><p>Speed est: ${info.mbps}</p></div>
                        <button class="btn-view" onclick="focarTorre(${tower.lat}, ${tower.lon}, ${tower.id}, '${info.operator}')">VIEW</button>
                    `;
                    list.appendChild(el);
                });
            } catch (e) {
                list.innerHTML = `<div class="msg-status" style="color:red;">Error: ${e.message}</div>`;
            } finally {
                btn.disabled = false; btn.innerText = "SEARCH AREA";
            }
        }

        function focarTorre(lat, lon, id, op) {
            toggleSearch(false);
            map.setView([lat, lon], 17);
            L.popup().setLatLng([lat, lon])
                .setContent(`<div style="text-align:center; font-family:sans-serif;"><b>${op}</b><br>ID: ${id}<br><br><button class="btn-main" style="padding:8px; font-size:13px;" onclick="toggleComments(true, '${id}')">üí¨ OPEN CHAT</button></div>`)
                .openOn(map);
            carregarMapa();
        }

        // SECURITY & CHAT LINK LOGIC
        function checkForLinks(text) {
            const urlPattern = /(https?:\/\/[^\s]+)/g;
            const match = text.match(urlPattern);
            if (match) {
                showSecurityAlert(match[0]);
                return true;
            }
            return false;
        }

        function showSecurityAlert(url) {
            const alert = document.getElementById('security-alert');
            const display = document.getElementById('malicious-url-display');
            const btn = document.getElementById('btn-proceed-risk');
            
            display.innerText = url;
            alert.style.display = 'flex';
            
            let timeLeft = 10;
            btn.disabled = true;
            btn.className = 'btn-proceed-locked';
            
            const timer = setInterval(() => {
                timeLeft--;
                btn.innerText = `Wait (${timeLeft}s)...`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerText = "Proceed anyway (UNSAFE)";
                    btn.className = 'btn-proceed-locked btn-proceed-unlocked';
                    btn.onclick = () => window.open(url, '_blank');
                }
            }, 1000);
        }

        function closeSecurityAlert() {
            document.getElementById('security-alert').style.display = 'none';
        }

        function toggleToS(show) {
            document.getElementById('login-frame').style.display = show ? 'none' : 'block';
            document.getElementById('tos-frame').style.display = show ? 'block' : 'none';
        }

        document.getElementById('comm-input').addEventListener('input', function(e) {
            const btn = document.getElementById('btn-send-comm');
            const len = e.target.value.length;
            btn.disabled = !(len > 10 && len < 100);
        });

        function toggleComments(show, towerId = null) {
            const frame = document.getElementById('comment-frame');
            if (show) {
                frame.classList.add('active');
                if(towerId) {
                    currentTowerId = towerId.toString();
                    document.getElementById('comm-tower-title').innerText = `Tower #${currentTowerId} Chat`;
                    carregarComentariosFirebase();
                }
            } else {
                frame.classList.remove('active');
                setTimeout(() => { document.getElementById('comm-container').innerHTML = ''; }, 400);
            }
        }

        async function carregarComentariosFirebase() {
            const container = document.getElementById('comm-container');
            container.innerHTML = '<div class="loader-inline"></div>';
            try {
                if(!window.db) return;
                const q = window.query(window.collection(window.db, "comments"), window.where("towerId", "==", currentTowerId), window.orderBy("createdAt", "desc"));
                const querySnapshot = await window.getDocs(q);
                container.innerHTML = "";
                if (querySnapshot.empty) {
                    container.innerHTML = '<div class="msg-status">No reports yet. Be the first!</div>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Just now';
                    const div = document.createElement('div');
                    div.className = 'comm-item';
                    div.innerHTML = `<strong onclick="checkForLinks('${data.text}')" style="cursor:pointer">User</strong>: ${data.text}<span class="comm-date">${date}</span>`;
                    container.appendChild(div);
                });
            } catch (e) {
                container.innerHTML = '<div class="msg-status" style="color:red">Failed to load reports.</div>';
            }
        }

        async function enviarComentarioFirebase() {
            const input = document.getElementById('comm-input');
            const btn = document.getElementById('btn-send-comm');
            const text = input.value.trim();
            if (text.length <= 10 || text.length >= 100) return;
            
            input.disabled = true; btn.disabled = true;
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '...';

            try {
                await window.addDoc(window.collection(window.db, "comments"), {
                    towerId: currentTowerId,
                    text: text,
                    createdAt: window.Timestamp.now(),
                    user: window.getCurrentUserName ? window.getCurrentUserName() : "Anonymous"
                });
                input.value = "";
                await carregarComentariosFirebase();
            } catch (e) {
                alert("Error sending report.");
            } finally {
                input.disabled = false;
                btn.innerHTML = originalIcon;
                input.focus();
            }
        }

        let loadingMap = false;
        async function carregarMapa() {
            if(map.getZoom() < 14 || loadingMap) return;
            loadingMap = true;
            try {
                const b = map.getBounds();
                const query = `[out:json][timeout:10];(node["man_made"~"mast|tower"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out body;`;
                const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
                const data = await res.json();
                data.elements.forEach(el => {
                    const info = analisarTags(el.tags);
                    const icon = L.divIcon({ html: '<div style="font-size:26px; filter:drop-shadow(0 2px 3px rgba(0,0,0,0.3));">üóº</div>', className: '', iconSize: [30,30] });
                    L.marker([el.lat, el.lon], {icon: icon}).addTo(markersLayer)
                     .bindPopup(`<b>${info.operator}</b><br>${info.html}<br><button style="margin-top:5px; background:#007aff; color:white; border:none; padding:6px 12px; border-radius:8px; cursor:pointer;" onclick="toggleComments(true, '${el.id}')">Chat / Report</button>`);
                });
            } catch(e) {} finally { loadingMap = false; }
        }

        function toggleGPS() {
            const btn = document.getElementById('locate-btn');
            if(watchId) {
                navigator.geolocation.clearWatch(watchId); watchId = null; btn.classList.remove('active');
            } else {
                btn.classList.add('active');
                watchId = navigator.geolocation.watchPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    if(!userMarker) {
                        userMarker = L.circleMarker([latitude, longitude], {radius:8, color:'white', fillColor:'#007aff', fillOpacity:1}).addTo(map);
                        map.setView([latitude, longitude], 15);
                    } else { userMarker.setLatLng([latitude, longitude]); }
                    carregarMapa();
                }, err => alert("GPS Error"), { enableHighAccuracy: true });
            }
        }

        function toggleSearch(s) { document.getElementById('search-overlay').style.display = s ? 'flex' : 'none'; }
        function toggleConfig(s) { document.getElementById('config-overlay').style.display = s ? 'flex' : 'none'; }

        map.on('moveend', carregarMapa);
        document.getElementById('dark-mode-toggle').checked = true;
        alterarTema(true);
    </script>
</body>
</html>
