<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tower Radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #8b5cf6; --bg: #000; --border: #262626; --skeleton: #1a1a1a; --text-sec: #a8a8a8; }
        body { background: var(--bg); color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; overflow: hidden; }
        
        /* Map Adjustments */
        #map { height: 100vh; width: 100%; display: none; filter: contrast(1.1) brightness(0.8) saturate(0.8); }

        /* Loader & Animations */
        .loader { width: 40px; height: 40px; border: 3px solid #333; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Modal Transitions */
        .frame-overlay { 
            position: fixed; inset: 0; background: #000; z-index: 50; 
            display: flex; flex-direction: column; 
            transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .frame-overlay.active { transform: translateY(0); }
        
        .frame-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: #000; z-index: 10; }
        .frame-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* INSTAGRAM STYLE FEED */
        .comment-item { 
            padding: 14px 16px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            gap: 12px; 
            align-items: flex-start;
        }
        .avatar { 
            width: 38px; height: 38px; 
            border-radius: 50%; 
            background: #222; 
            object-fit: cover; 
            flex-shrink: 0;
            border: 1px solid #333;
        }
        .comm-content { flex: 1; font-size: 14px; }
        
        .comm-header { 
            display: flex; 
            align-items: baseline; 
            gap: 6px; 
            margin-bottom: 2px;
        }
        .comm-user { font-weight: 600; color: #fff; font-size: 14px; }
        .comm-id { font-size: 12px; color: var(--text-sec); font-family: monospace; }
        .comm-time { font-size: 12px; color: var(--text-sec); margin-left: auto; }
        
        .comm-text { 
            color: #f5f5f5; 
            line-height: 1.4; 
            white-space: pre-wrap; 
            word-break: break-word; 
        }

        .comm-actions { 
            display: flex; 
            gap: 20px; 
            margin-top: 8px; 
            align-items: center; 
        }
        
        .action-btn { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            cursor: pointer; 
            color: var(--text-sec);
            font-size: 12px;
            font-weight: 500;
        }
        .action-btn:hover { color: #fff; }
        .action-btn svg { width: 18px; height: 18px; stroke-width: 2; }
        .action-btn.liked { color: #ef4444; }
        .action-btn.liked svg { fill: #ef4444; stroke: none; }

        /* Utilities */
        .icon { width: 24px; height: 24px; stroke: white; stroke-width: 2; fill: none; }
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 30px; display: none; z-index: 1000; font-weight: 600; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); background: #333; border: 1px solid #444; }
    </style>
</head>
<body>

    <div id="boot-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-black z-[100]">
        <div id="boot-loader" class="loader"></div>
        <div id="boot-status" class="text-neutral-500 font-mono text-[10px] mt-4 uppercase tracking-widest">CONNECTING SERVER...</div>
        <div id="boot-error" class="text-red-500 font-mono text-xs mt-4 hidden text-center px-10"></div>
    </div>

    <div id="login-screen" class="fixed inset-0 bg-black z-[90] hidden p-8 flex flex-col justify-between">
        <div class="mt-20">
            <h1 class="text-3xl font-bold leading-tight tracking-tight">Tower Radar<br><span class="text-neutral-500 text-xl font-normal">Log in to access the network.</span></h1>
        </div>
        <div class="mb-6 w-full">
            <button id="btn-google" class="w-full bg-white text-black font-bold py-3.5 rounded-full flex items-center justify-center gap-3 transition active:scale-95">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27 3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10 5.35 0 9.25-3.67 9.25-9.09 0-1.15-.15-1.81-.15-1.81z"/></svg>
                Continue with Google
            </button>
            <div class="pt-6 border-t border-white/10 text-center mt-6">
                <p class="text-white/40 text-[11px]">By continuing, you agree to our <a href="#" class="text-white underline">Terms & Rules</a>.</p>
            </div>
        </div>
    </div>

    <div id="map"></div>
    <div id="map-ui" class="hidden">
        <button onclick="openFrame('settings-frame')" class="fixed top-5 right-5 z-20 bg-black/80 p-3 rounded-full border border-white/10 backdrop-blur-md active:scale-90 transition">
            <svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
        <button onclick="locateMe()" class="fixed bottom-10 right-5 z-20 bg-purple-600 p-4 rounded-2xl shadow-lg active:scale-90 transition">
            <svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
        </button>
    </div>

    <div id="settings-frame" class="frame-overlay">
        <div class="frame-header">
            <button onclick="closeFrame('settings-frame')"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h2 class="font-bold text-lg">Menu</h2>
            <div class="w-6"></div>
        </div>
        <div class="frame-content px-4 py-4 space-y-4">
            <button onclick="openProfile(currentUserUid)" class="w-full p-4 flex items-center justify-between bg-[#111] rounded-xl border border-white/5 active:bg-white/10">
                <span class="font-medium">My Profile</span>
            </button>
            <a href="#" class="block w-full text-left p-4 text-sm text-gray-500 hover:text-white transition">Terms of Service</a>
        </div>
    </div>

    <div id="profile-frame" class="frame-overlay z-[60]">
        <div class="frame-header">
            <button onclick="closeFrame('profile-frame')"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg></button>
            <h2 class="font-bold">Profile</h2>
            <button onclick="showReport()"><svg class="icon" style="stroke: #ef4444;" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg></button>
        </div>
        <div id="profile-loading-state" class="flex-1 flex items-center justify-center"><div class="loader"></div></div>
        <div id="profile-content" class="frame-content hidden">
            <div class="flex items-center gap-4 p-6 border-b border-white/10">
                <img id="p-avatar" class="w-20 h-20 rounded-full bg-gray-800 border-2 border-black">
                <div>
                    <h3 id="p-name" class="text-xl font-bold"></h3>
                    <p id="p-uid" class="text-gray-500 font-mono text-xs"></p>
                </div>
            </div>
            <div id="profile-posts-list" class="pb-10"></div>
        </div>
    </div>

    <div id="tower-frame" class="frame-overlay z-[70]">
        <div class="frame-header">
            <button onclick="closeFrame('tower-frame')"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h2 id="tower-header-title" class="font-bold text-sm tracking-wide">TOWER FEED</h2>
            <div class="w-6"></div>
        </div>
        
        <div class="frame-content bg-black" id="feed-container"></div>

        <div class="p-3 border-t border-white/10 bg-black flex gap-3 items-center pb-6">
            <input id="post-input" type="text" placeholder="Add a comment..." class="flex-1 bg-[#161616] text-white px-4 py-3 rounded-full outline-none border border-transparent focus:border-white/20 transition placeholder-gray-600 text-sm">
            <button id="post-btn" class="bg-purple-600 p-3 rounded-full flex items-center justify-center text-white disabled:opacity-50 font-bold text-sm">Post</button>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-black/80 z-[200] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-[#161616] p-6 rounded-2xl text-center border border-white/10 max-w-xs w-full">
            <div class="w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 stroke-red-500 fill-none" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
            </div>
            <h3 class="font-bold text-lg mb-2">Report Content</h3>
            <p class="mb-6 text-sm text-gray-400 leading-relaxed">To report this user/content, please send proof to the TikTok account <b>@fmafioso</b>.</p>
            <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="w-full bg-white text-black py-3 rounded-full font-bold hover:bg-gray-200">Close</button>
        </div>
    </div>

    <div id="toast"></div>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, limit, startAfter, serverTimestamp, doc, getDoc, setDoc, updateDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-9mGZUB4m_vuc8mAATPtpiQdinb4nYx0",
            authDomain: "radar-database-3448b.firebaseapp.com",
            projectId: "radar-database-3448b",
            storageBucket: "radar-database-3448b.firebasestorage.app",
            messagingSenderId: "927242352551",
            appId: "1:927242352551:web:a980043e310d5dc1e2e882"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let map, markersLayer, currentUser = null;
        window.currentUserUid = null;
        let currentTowerId = null, lastDoc = null, isFeedLoading = false;

        // --- 1. BOOT & AUTH CHECK ---
        window.onload = () => {
            onAuthStateChanged(auth, async (user) => {
                const statusEl = document.getElementById('boot-status');
                if (user) {
                    statusEl.innerText = "CHECKING CREDENTIALS...";
                    currentUser = user;
                    window.currentUserUid = user.uid;
                    try {
                        await ensureUserDoc(user);
                        document.getElementById('boot-screen').classList.add('hidden');
                        initMap();
                    } catch (e) {
                        showBootError("Security Error: " + e.message);
                    }
                } else {
                    document.getElementById('boot-screen').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                }
            });
        };

        // FIXED: Only sends fields allowed by your Security Rules
        async function ensureUserDoc(user) {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, {
                    dailyCount: 0,
                    lastPost: serverTimestamp(),
                    lastResetDay: new Date().getDate()
                });
            }
        }

        function showBootError(msg) {
            const el = document.getElementById('boot-error');
            el.innerText = msg;
            el.classList.remove('hidden');
            document.getElementById('boot-loader').style.display = 'none';
        }

        document.getElementById('btn-google').onclick = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch (e) { alert("Login failed: " + e.code); }
        };

        // --- 2. MAP LOGIC ---
        function initMap() {
            document.getElementById('map').style.display = 'block';
            document.getElementById('map-ui').classList.remove('hidden');
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-23.55, -46.63], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            map.on('moveend', fetchTowers);
            fetchTowers();
        }

        async function fetchTowers() {
            if (map.getZoom() < 14) return;
            const b = map.getBounds();
            const q = `[out:json][timeout:15];(node["man_made"~"mast|tower"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out body;`;
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(q));
                const data = await res.json();
                markersLayer.clearLayers();
                data.elements.forEach(t => {
                    const icon = L.divIcon({ html: `<div style="width:12px;height:12px;background:#8b5cf6;border:2px solid white;border-radius:50%;box-shadow:0 0 10px rgba(139,92,246,0.6)"></div>`, className: '' });
                    L.marker([t.lat, t.lon], {icon}).addTo(markersLayer).on('click', () => window.openTower(t.id));
                });
            } catch (e) { console.log(e); }
        }

        // --- 3. FEED (INSTAGRAM STYLE) ---
        window.openTower = (id) => {
            currentTowerId = id;
            document.getElementById('tower-header-title').innerText = `TOWER #${id}`;
            const frame = document.getElementById('tower-frame');
            frame.style.display = 'flex';
            setTimeout(() => frame.classList.add('active'), 10);
            
            lastDoc = null;
            document.getElementById('feed-container').innerHTML = ''; // Clear
            loadComments();
        };

        async function loadComments() {
            if (isFeedLoading) return;
            isFeedLoading = true;
            const container = document.getElementById('feed-container');

            try {
                let q = query(collection(db, "comments"), where("towerId", "==", String(currentTowerId)), orderBy("createdAt", "desc"), limit(15));
                if (lastDoc) q = query(q, startAfter(lastDoc));

                const snap = await getDocs(q);
                if (snap.empty && !lastDoc) {
                    container.innerHTML = `<div class="p-10 text-center text-gray-500 text-sm">Be the first to comment on this tower.</div>`;
                }
                
                lastDoc = snap.docs[snap.docs.length - 1];
                snap.forEach(d => container.innerHTML += createCommentHTML(d.data(), d.id));

            } catch (e) { console.error(e); }
            isFeedLoading = false;
        }

        // --- 4. POST LOGIC ---
        document.getElementById('post-btn').onclick = async () => {
            const input = document.getElementById('post-input');
            const txt = input.value.trim();
            if (txt.length < 10) { showToast("Min 10 chars", true); return; }

            try {
                const batch = writeBatch(db);
                const commentRef = doc(collection(db, "comments"));
                
                batch.set(commentRef, {
                    text: txt,
                    userId: currentUser.uid,
                    username: currentUser.displayName,
                    userPhoto: currentUser.photoURL,
                    towerId: String(currentTowerId),
                    likes: 0,
                    createdAt: serverTimestamp()
                });
                
                batch.update(doc(db, "users", currentUser.uid), {
                    dailyCount: increment(1),
                    lastPost: serverTimestamp()
                });

                await batch.commit();
                input.value = "";
                lastDoc = null; 
                document.getElementById('feed-container').innerHTML = ""; 
                loadComments();
                showToast("Posted!");

            } catch (e) { showToast("Error: " + e.code, true); }
        };

        // --- 5. PROFILE LOGIC ---
        window.openProfile = async (uid) => {
            document.getElementById('settings-frame').classList.remove('active');
            const frame = document.getElementById('profile-frame');
            frame.style.display = 'flex';
            setTimeout(() => frame.classList.add('active'), 10);
            
            document.getElementById('profile-loading-state').classList.remove('hidden');
            document.getElementById('profile-content').classList.add('hidden');

            // Visual Data comes from Auth or Comments history, since Users doc is restricted
            if(uid === currentUser.uid) {
                 fillProfileUI(currentUser.displayName, currentUser.photoURL, uid);
            } else {
                 // Try to find a comment from this user to get Name/Photo
                 const q = query(collection(db, "comments"), where("userId", "==", uid), limit(1));
                 const snap = await getDocs(q);
                 if(!snap.empty) {
                     const d = snap.docs[0].data();
                     fillProfileUI(d.username, d.userPhoto, uid);
                 } else {
                     fillProfileUI("Unknown User", "", uid);
                 }
            }

            // Load Posts
            const list = document.getElementById('profile-posts-list');
            list.innerHTML = "";
            const qPosts = query(collection(db, "comments"), where("userId", "==", uid), orderBy("createdAt", "desc"), limit(10));
            const snapP = await getDocs(qPosts);
            snapP.forEach(d => list.innerHTML += createCommentHTML(d.data(), d.id));
            
            document.getElementById('profile-loading-state').classList.add('hidden');
            document.getElementById('profile-content').classList.remove('hidden');
        };

        function fillProfileUI(name, photo, uid) {
            document.getElementById('p-name').innerText = name;
            document.getElementById('p-avatar').src = photo || "https://via.placeholder.com/100";
            document.getElementById('p-uid').innerText = "ID: " + uid;
        }

        // --- HTML GENERATORS ---
        function createCommentHTML(data, id) {
            const shortId = data.userId ? data.userId.slice(-4) : '????';
            const likeCount = (data.likes && data.likes > 0) ? data.likes : ''; // Hidden if 0
            
            // Heart Icon
            const heartSvg = `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
            
            // Flag Icon
            const flagSvg = `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>`;

            return `
            <div class="comment-item">
                <img src="${data.userPhoto}" class="avatar" onclick="openProfile('${data.userId}')">
                <div class="comm-content">
                    <div class="comm-header">
                        <span class="comm-user">${data.username}</span>
                        <span class="comm-id">#${shortId}</span>
                    </div>
                    <div class="comm-text">${data.text}</div>
                    <div class="comm-actions">
                        <div class="action-btn">
                            ${heartSvg}
                            <span>${likeCount}</span>
                        </div>
                        <div class="action-btn" onclick="showReport()">
                            ${flagSvg}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // --- UTILS ---
        window.closeFrame = (id) => {
            const el = document.getElementById(id);
            el.classList.remove('active');
            setTimeout(() => el.style.display = 'none', 350);
        };
        window.showReport = () => document.getElementById('report-modal').classList.remove('hidden');
        window.locateMe = () => map.locate({setView: true, maxZoom: 16});
        window.openFrame = (id) => {
             const el = document.getElementById(id);
             el.style.display = 'flex';
             setTimeout(()=>el.classList.add('active'),10);
        };

        function showToast(msg, isErr=false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.border = isErr ? '1px solid #ef4444' : '1px solid #22c55e';
            t.style.display = 'flex';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
