<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Radar Ultra Pro - iOS 18 Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --ios-bg: #f2f2f7;
            --ios-item: #ffffff;
            --ios-text: #000000;
            --ios-accent: #007aff;
            --ios-danger: #ff3b30;
            --ios-success: #34c759;
            --ios-border: rgba(60, 60, 67, 0.29);
            --ios-blur: rgba(255, 255, 255, 0.7);
        }

        body.dark-mode {
            --ios-bg: #000000;
            --ios-item: #1c1c1e;
            --ios-text: #ffffff;
            --ios-accent: #0a84ff;
            --ios-border: rgba(84, 84, 88, 0.65);
            --ios-blur: rgba(28, 28, 30, 0.8);
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            background: var(--ios-bg);
            color: var(--ios-text);
            overflow: hidden;
            height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease;
        }

        /* MAPA */
        #map { height: 100vh; width: 100%; z-index: 1; transition: filter 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .map-blur-effect { filter: blur(12px) brightness(0.7); pointer-events: none; }

        /* iOS 18 DYNAMIC BANNER (REPLACING ALERTS) */
        #ios-notification-system {
            position: fixed;
            top: -120px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 420px;
            background: var(--ios-blur);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            padding: 14px 20px;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
            z-index: 1000000;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.6s cubic-bezier(0.2, 1, 0.2, 1);
            border: 0.5px solid var(--ios-border);
        }
        #ios-notification-system.visible { top: 20px; }
        .notif-icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        /* CUSTOM iOS TOGGLE SWITCH */
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 32px;
        }
        .ios-switch input { opacity: 0; width: 0; height: 0; }
        .ios-switch-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #e9e9eb;
            transition: .4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 34px;
        }
        .dark-mode .ios-switch-slider { background-color: #39393d; }
        .ios-switch-slider:before {
            position: absolute;
            content: "";
            height: 28px;
            width: 28px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        input:checked + .ios-switch-slider { background-color: #34c759; }
        input:checked + .ios-switch-slider:before { transform: translateX(22px); }

        /* ADVANCED COMMENT SYSTEM LAYOUT */
        .comment-entry {
            background: var(--ios-item);
            margin-bottom: 16px;
            padding: 18px;
            border-radius: 24px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            animation: slideUpIn 0.5s ease-out;
            border: 0.5px solid var(--ios-border);
        }
        @keyframes slideUpIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .user-pfp { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            object-fit: cover; 
            background: #d1d1d6; 
            border: 1.5px solid var(--ios-accent);
            flex-shrink: 0;
        }
        .comment-main { flex: 1; min-width: 0; }
        .user-alias { 
            font-weight: 700; 
            font-size: 15px; 
            color: var(--ios-accent); 
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .comment-text { 
            font-size: 16px; 
            line-height: 1.45; 
            color: var(--ios-text); 
            word-wrap: break-word; 
        }
        .comment-meta { font-size: 11px; opacity: 0.5; margin-top: 8px; font-weight: 500; }
        
        /* LIKES SECTION (RIGHT SIDE) */
        .engagement-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-left: 12px;
            border-left: 0.5px solid var(--ios-border);
            min-width: 45px;
        }
        .heart-trigger { 
            background: none; 
            border: none; 
            font-size: 22px; 
            cursor: pointer; 
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            padding: 0;
        }
        .heart-trigger:active { transform: scale(1.4); }
        .count-display { font-size: 12px; font-weight: 800; margin-top: 2px; color: var(--ios-text); }

        /* OVERLAYS & INTERFACE */
        .fab-icon {
            position: absolute;
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .fab-icon:active { transform: scale(0.9); }
        .search-trigger { bottom: 40px; right: 25px; background: var(--ios-accent); color: white; }
        .config-trigger { bottom: 40px; left: 25px; background: var(--ios-item); color: var(--ios-text); }
        .gps-trigger { bottom: 115px; right: 25px; background: var(--ios-item); color: var(--ios-text); }
        .gps-trigger.active { background: var(--ios-accent); color: white; }

        .fullscreen-overlay { 
            position: fixed; 
            inset: 0; 
            background: var(--ios-bg); 
            z-index: 9999; 
            display: none; 
            flex-direction: column; 
            padding: 30px 25px; 
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-title { font-size: 34px; font-weight: 800; letter-spacing: -1px; margin: 0 0 25px 0; }

        /* CHAT SHEET (TIKTOK STYLE) */
        #comment-module { position: fixed; inset: 0; z-index: 10005; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        .sheet-dimmer { position: absolute; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; transition: 0.4s; pointer-events: auto; }
        .bottom-sheet { 
            background: var(--ios-bg); 
            width: 100%; 
            height: 85vh; 
            border-radius: 35px 35px 0 0; 
            display: flex; 
            flex-direction: column; 
            transform: translateY(100%); 
            transition: transform 0.5s cubic-bezier(0.3, 1, 0.3, 1); 
            pointer-events: auto; 
            box-shadow: 0 -15px 50px rgba(0,0,0,0.4); 
            position: relative;
        }
        #comment-module.active .sheet-dimmer { opacity: 1; }
        #comment-module.active .bottom-sheet { transform: translateY(0); }

        .sheet-drag-handle { width: 40px; height: 5px; background: var(--ios-border); border-radius: 10px; align-self: center; margin: 12px 0; }
        
        .chat-header { 
            padding: 0 25px 15px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 0.5px solid var(--ios-border); 
        }
        .chat-scroller { flex: 1; overflow-y: auto; padding: 20px 25px; -webkit-overflow-scrolling: touch; }
        
        .composer-area { 
            padding: 15px 20px 45px 20px; 
            background: var(--ios-item); 
            border-top: 0.5px solid var(--ios-border); 
            display: flex; 
            gap: 12px; 
            align-items: center; 
        }
        .ios-input { 
            flex: 1; 
            padding: 14px 20px; 
            border-radius: 25px; 
            border: none; 
            background: rgba(118, 118, 128, 0.12); 
            color: var(--ios-text); 
            font-size: 17px; 
            outline: none; 
        }
        .send-btn { 
            background: var(--ios-accent); 
            color: white; 
            border: none; 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            font-size: 22px; 
            font-weight: bold; 
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .send-btn:disabled { opacity: 0.3; transform: scale(0.9); }

        /* AUTH SCREEN */
        #gateway-auth { 
            position: fixed; 
            inset: 0; 
            background: var(--ios-bg); 
            z-index: 200000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .auth-container { text-align: center; padding: 40px; width: 100%; max-width: 350px; }
        .google-login-btn { 
            background: var(--ios-text); 
            color: var(--ios-bg); 
            border: none; 
            padding: 18px; 
            border-radius: 20px; 
            width: 100%; 
            font-weight: 700; 
            font-size: 16px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            cursor: pointer; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="dark-mode">

    <div id="ios-notification-system">
        <div id="notif-icon" class="notif-icon">üí°</div>
        <div style="flex: 1;">
            <b id="notif-title" style="display: block; font-size: 15px;">System</b>
            <span id="notif-message" style="font-size: 14px; opacity: 0.8;">...</span>
        </div>
    </div>

    <div id="gateway-auth">
        <div class="auth-container">
            <div style="font-size: 70px; margin-bottom: 25px;">üì°</div>
            <h2 style="font-size: 30px; font-weight: 850; letter-spacing: -1.5px; margin-bottom: 10px;">Radar Ultra Pro</h2>
            <p style="opacity: 0.6; margin-bottom: 40px; line-height: 1.5;">Identify yourself to access the global tower network and real-time reports.</p>
            <button class="google-login-btn" onclick="initGoogleAuth()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" width="22">
                Continue with Google
            </button>
            <p style="font-size: 12px; margin-top: 30px; opacity: 0.4;">By continuing, you agree to our Terms of Service.</p>
        </div>
    </div>

    <div id="settings-frame" class="fullscreen-overlay">
        <div class="chat-header" style="padding: 0 0 20px 0;">
            <h2 class="section-title">Settings</h2>
            <button onclick="closeSettings()" style="background:rgba(118,118,128,0.2); border:none; border-radius:50%; width:35px; height:35px; color:var(--ios-text); font-weight:bold;">‚úï</button>
        </div>
        <div style="background:var(--ios-item); padding:22px; border-radius:24px; display:flex; justify-content:space-between; align-items:center; border: 0.5px solid var(--ios-border);">
            <span style="font-weight:600; font-size: 18px;">Dark Mode</span>
            <label class="ios-switch">
                <input type="checkbox" id="dark-mode-switch" onchange="switchTheme(this.checked)" checked>
                <span class="ios-switch-slider"></span>
            </label>
        </div>
    </div>

    <div id="search-frame" class="fullscreen-overlay">
        <div class="chat-header" style="padding: 0 0 20px 0;">
            <h2 class="section-title">Explore</h2>
            <button onclick="closeSearch()" style="background:rgba(118,118,128,0.2); border:none; border-radius:50%; width:35px; height:35px; color:var(--ios-text); font-weight:bold;">‚úï</button>
        </div>
        <input type="text" id="geo-search-input" class="ios-input" placeholder="City, Zip code or Coordinates..." style="border-radius: 18px; margin-bottom: 15px;">
        <button onclick="executeScan()" style="background:var(--ios-accent); color:white; border:none; padding:18px; border-radius:20px; font-weight:700; font-size:17px; box-shadow: 0 8px 20px rgba(0,122,255,0.3);">SCAN AREA</button>
        <div id="search-results" style="flex:1; overflow-y:auto; margin-top:25px;"></div>
    </div>

    <div id="comment-module">
        <div class="sheet-dimmer" onclick="hideComments()"></div>
        <div class="bottom-sheet">
            <div class="sheet-drag-handle"></div>
            <div class="chat-header">
                <h3 id="tower-header-id" style="margin:0; font-size:22px; font-weight:850; letter-spacing: -0.5px;">Tower Intel</h3>
                <button onclick="hideComments()" style="background:none; border:none; color:var(--ios-accent); font-weight:700; font-size:17px;">Done</button>
            </div>
            <div id="chat-list-container" class="chat-scroller"></div>
            <div class="composer-area">
                <input type="text" id="report-input-field" class="ios-input" placeholder="Write a report (min. 10 chars)...">
                <button id="submit-report-btn" onclick="publishIntel()" disabled class="send-btn">‚Üë</button>
            </div>
        </div>
    </div>

    <button class="fab-icon config-trigger" onclick="openSettings()">‚öôÔ∏è</button>
    <button id="gps-action-btn" class="fab-icon gps-trigger" onclick="requestGPS()">üõ∞Ô∏è</button>
    <button class="fab-icon search-trigger" onclick="openSearch()">üîç</button>

    <div id="map"></div>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, Timestamp, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyD-9mGZUB4m_vuc8mAATPtpiQdinb4nYx0",
            authDomain: "radar-database-3448b.firebaseapp.com",
            projectId: "radar-database-3448b",
            storageBucket: "radar-database-3448b.firebasestorage.app",
            messagingSenderId: "927242352551",
            appId: "1:927242352551:web:a980043e310d5dc1e2e882"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // GLOBAL STATES
        let currentUser = null;
        let selectedTowerId = null;
        let gpsWatchId = null;
        let userMarker = null;

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-15.78, -47.92], 4);
        const tileLayer = L.tileLayer('').addTo(map);
        const towerGroup = L.layerGroup().addTo(map);

        // --- iOS NOTIFICATION SYSTEM (Replaces Alerts) ---
        window.pushIosNotify = (title, message, type = 'success') => {
            const banner = document.getElementById('ios-notification-system');
            const iconBox = document.getElementById('notif-icon');
            document.getElementById('notif-title').innerText = title;
            document.getElementById('notif-message').innerText = message;
            
            if (type === 'error') {
                iconBox.style.background = '#ff3b30';
                iconBox.innerText = '‚úï';
            } else {
                iconBox.style.background = '#34c759';
                iconBox.innerText = '‚úì';
            }

            banner.classList.add('visible');
            setTimeout(() => banner.classList.remove('visible'), 3500);
        };

        // --- AUTHENTICATION ---
        window.initGoogleAuth = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (e) {
                pushIosNotify("Auth Error", "Could not sign in with Google.", "error");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('gateway-auth').style.display = 'none';
                pushIosNotify("Identity Verified", `Welcome back, ${user.displayName.split(' ')[0]}`);
            } else {
                document.getElementById('gateway-auth').style.display = 'flex';
            }
        });

        // --- THEME ENGINE ---
        window.switchTheme = (isDark) => {
            document.body.classList.toggle('dark-mode', isDark);
            const style = isDark ? 'dark_all' : 'rastertiles/voyager';
            const url = isDark 
                ? `https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png`
                : `https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png`;
            tileLayer.setUrl(url);
        };

        // --- OVERPASS TOWER SCANNER ---
        async function fetchTowerData() {
            if (map.getZoom() < 14) return;
            const b = map.getBounds();
            const overpassQuery = `[out:json][timeout:20];(node["man_made"~"mast|tower"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});node["communication:mobile_phone"="yes"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out body;`;
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery));
                const data = await response.json();
                
                towerGroup.clearLayers();
                data.elements.forEach(element => {
                    const towerIcon = L.divIcon({ 
                        html: `<div style="font-size:32px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.4))">üóº</div>`, 
                        className: 'tower-node' 
                    });
                    
                    L.marker([element.lat, element.lon], { icon: towerIcon })
                     .addTo(towerGroup)
                     .on('click', () => {
                        selectedTowerId = element.id.toString();
                        showComments();
                     });
                });
            } catch (err) {
                console.error("OSM API Busy");
            }
        }

        // --- FIREBASE COMMENT SYSTEM (INTELLIGENCE) ---
        window.showComments = () => {
            document.getElementById('comment-module').classList.add('active');
            document.getElementById('map').classList.add('map-blur-effect');
            document.getElementById('tower-header-id').innerText = `Tower #${selectedTowerId.slice(-6)}`;
            loadIntelFromFirebase();
        };

        window.hideComments = () => {
            document.getElementById('comment-module').classList.remove('active');
            document.getElementById('map').classList.remove('map-blur-effect');
        };

        async function loadIntelFromFirebase() {
            const list = document.getElementById('chat-list-container');
            list.innerHTML = '<div style="text-align:center; padding:50px; opacity:0.5;">Accessing Encrypted Reports...</div>';
            
            try {
                const q = query(
                    collection(db, "tower_reports"), 
                    where("towerId", "==", selectedTowerId), 
                    orderBy("createdAt", "desc")
                );
                const snapshot = await getDocs(q);
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = '<div style="text-align:center; padding:50px; opacity:0.3; font-weight:600;">No signal reports found for this node.</div>';
                    return;
                }

                snapshot.forEach(entry => {
                    const data = entry.data();
                    const docId = entry.id;
                    const maskedName = data.userName ? data.userName.split(' ')[0] + " ‚Ä¢‚Ä¢‚Ä¢" : "Agent ‚Ä¢‚Ä¢‚Ä¢";
                    const timestamp = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "Now";

                    const item = document.createElement('div');
                    item.className = 'comment-entry';
                    item.innerHTML = `
                        <img src="${data.userImage || ''}" class="user-pfp" onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
                        <div class="comment-main">
                            <div class="user-alias">${maskedName}</div>
                            <div class="comment-text">${data.message}</div>
                            <span class="comment-meta">Reported at ${timestamp}</span>
                        </div>
                        <div class="engagement-box">
                            <button class="heart-trigger" onclick="window.processLike('${docId}')">‚ù§Ô∏è</button>
                            <span class="count-display">${data.likes || 0}</span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (e) {
                pushIosNotify("Database Error", "Failed to sync reports.", "error");
            }
        }

        window.publishIntel = async () => {
            const input = document.getElementById('report-input-field');
            const btn = document.getElementById('submit-report-btn');
            const text = input.value.trim();

            if (text.length < 10) return;

            input.disabled = true;
            btn.disabled = true;
            btn.innerText = "...";

            try {
                await addDoc(collection(db, "tower_reports"), {
                    towerId: selectedTowerId,
                    message: text,
                    userName: currentUser.displayName,
                    userImage: currentUser.photoURL,
                    userId: currentUser.uid,
                    likes: 0,
                    createdAt: Timestamp.now()
                });
                
                input.value = "";
                pushIosNotify("Intel Shared", "Signal report uploaded successfully.");
                loadIntelFromFirebase();
            } catch (e) {
                pushIosNotify("Transmission Failed", "Could not connect to database.", "error");
            } finally {
                input.disabled = false;
                btn.innerText = "‚Üë";
                btn.disabled = false;
            }
        };

        window.processLike = async (id) => {
            try {
                const reportRef = doc(db, "tower_reports", id);
                await updateDoc(reportRef, { likes: increment(1) });
                loadIntelFromFirebase();
            } catch (e) {
                console.error("Like failed");
            }
        };

        // --- GEOLOCATION & NAVIGATION ---
        window.requestGPS = () => {
            const btn = document.getElementById('gps-action-btn');
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
                btn.classList.remove('active');
                pushIosNotify("GPS Off", "Live tracking disabled.");
            } else {
                btn.classList.add('active');
                gpsWatchId = navigator.geolocation.watchPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    if (!userMarker) {
                        userMarker = L.circleMarker([latitude, longitude], { radius: 10, color: '#fff', weight: 3, fillOpacity: 1, fillColor: '#007aff' }).addTo(map);
                        map.flyTo([latitude, longitude], 16);
                    } else {
                        userMarker.setLatLng([latitude, longitude]);
                    }
                    fetchTowerData();
                }, () => pushIosNotify("GPS Error", "Please enable location services.", "error"), { enableHighAccuracy: true });
            }
        };

        window.executeScan = async () => {
            const input = document.getElementById('geo-search-input').value;
            if (!input) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`);
                const results = await res.json();
                if (results.length > 0) {
                    map.flyTo([results[0].lat, results[0].lon], 15);
                    closeSearch();
                    setTimeout(fetchTowerData, 1000);
                }
            } catch (e) {
                pushIosNotify("Search Error", "Location not found.", "error");
            }
        };

        // --- UI TOGGLES ---
        window.openSettings = () => document.getElementById('settings-frame').style.display = 'flex';
        window.closeSettings = () => document.getElementById('settings-frame').style.display = 'none';
        window.openSearch = () => document.getElementById('search-frame').style.display = 'flex';
        window.closeSearch = () => document.getElementById('search-frame').style.display = 'none';

        document.getElementById('report-input-field').addEventListener('input', (e) => {
            document.getElementById('submit-report-btn').disabled = e.target.value.length < 10;
        });

        map.on('moveend', fetchTowerData);
        switchTheme(true); // Default Dark Mode
    </script>
</body>
</html>
